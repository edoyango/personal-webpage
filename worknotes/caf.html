<!doctype html>
<html>
    <head>
        <title>Ed Space - Worknotes</title>
        <link href="/css/general.css" rel="stylesheet">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
        <link href="/css/fortran-syntax.css" rel="stylesheet">
        <link href="/css/cpp-syntax.css" rel="stylesheet">
    </head>
    <body>
    
        <!-- Top navigation bar -->
        <nav class="navbar navbar-default sticky-top">
            <div class="container-fluid">
                <ul class="nav navbar-nav">
                    <li class="nav-item"><a href="/index.html">Home</a></li>
                    <li class="nav-item"><a href="/about.html">About Me</a></li>
                    <li class="nav-item active"><a href="/worknotes/index.html">Work Notes</a></li>
                    <li class="nav-item"><a href="/trips/index.html">Trips</a></li>
                    <li class="nav-item"><a href="/apps/index.html">Web Tools</a></li>
                  </ul>
            </div>
        </nav>
        
        <div class="normalwidth">
            <h1>Coarray Fortran Things</h1>
            <p>ignoring the basics. Best tutorial to start with is <a href="https://github.com/tkoenig1/coarray-tutorial/blob/main/tutorial.md">this one</a>. Basic, but couldn't find very beginner friendly ones.</p>
            <h2>Install</h2>
            <p><a href="http://www.opencoarrays.org/">OpenCoarrays</a> is a library usable with gfortran and uses MPI 1-sided comms as the to perform the communications. install via linuxbrew or spack.</p>
            <p>Intel compilers don't rely on external libraries and should be ready to use coarrays with intel-MPI. It only requires compilation with -coarray option.</p>
            <h2>Compiling and Running</h2>
            <h3>GNU + Opencoarrays</h3>
            <p>Compile: <code>caf -fcoarray=lib</code></p>
            <p><code>caf</code> is just a wrapper around the <code>mpif90</code> command, which is in turn a wrapper around the underlying compiler (in this case <code>gfortran</code>). But you can always use the command <code>caf --show</code> to see the include flags and libraries, in case you don't want to use the <code>caf</code> wrapper.</p>
            <p>run: <code>cafrun [MPI options] yourprogram</code></p>
            <p>To compile for a single image (i.e., serial): <code>gfortran -fcoarray=single ...</code> and execute like any other executable (<code>./myprogram</code>).</p>
            <h3>Intel</h3>
            <p>Compile: <code>ifort -coarray</code>. Run like any other program: <code>./myprogram</code>. Control the number of images with the <code>FOR_COARRAY_NUM_IMAGES</code> environment variable.</p>
            <p>To compile for a single image (serial): <code>ifort -coarray=single</code>. However, unlike GNU+OpenCoarrays, you can still execute this executable with <code>mpiexec [MPI options] myprogram</code>.</p>
            <p>note the intel compiler caf shared library requires intel mpi (even if compiling with <code>-coarray=single</code>)</p>

            <h2>Defining static coarrays</h2>
            <p>For variables with copies on all images, just add [*] to end of variable declaration e.g.,</p>
            <pre><code><span class="fstd">integer</span>:: a[*] <span class="fcomment">! a has a copy on each image</span>
<span class="fstd">real</span>:: b(2, 2)[*] <span class="fcomment">! each image will have b, a 2x2 array</span>
<span class="fstd">logical</span>, <span class="fstd">codimension</span>[*]:: c(3, 3, 3) <span class="fcomment">! the codimension property can be used instead.</span></code></pre>
            <p>user defined types are defined in the normal way as well.</p>
            <pre><code><span class="fstd">type</span>(my_type):: d[*]
<span class="fstd">type</span>(my_type2), <span class="fstd">codimension</span>[*]:: e(10)</code></pre>
            <h2>Defining and allocating allocatable coarrays</h2>
            <p>Like static variables, allocatable variables are defined with the <code>[:]</code> suffix or with the codimension property. The colon being used instead of the * is needed and means the number of images is being deferred (maybe you can allocate variables only on some images then? Needs testing).</p>
            <pre><code><span class="fstd">real</span>, <span class="fstd">allocatable</span>:: f(:)[:]
<span class="fstd">integer</span>, <span class="fstd">allocatable</span>, <span class="fstd">codimension</span>[:]:: g(:,:)</code></pre>
            <p>Remember that when you allocate the array, you must allocate them using the same size. The program will continue without issue,
                but references to other images' arrays will be misplaced. This is because each image uses the allocated size of its local copy as a template for other images' copies of the variable (from what I can tell - tested with gfortran and opencoarrays).</p>
            <h2>Coarrays in subroutines/functions</h2>
            <p>the codimension property can be used to declare input variables of a subroutine.</p>
            <p>Coarrays in subroutines/functions must either be: passed as an argument, defined as allocatable, or with the save attribute to be declared. The save attribute is for when you know the number of images to be used in the subroutine. allocatable must be used otherwise.</p>
            <h2>Some notes on performance</h2>
            <p><code>MPI/osh_put</code> are generally faster than gets, so keep that in mind when writing algorithms. (<a href="https://fortran.bcs.org/2017/GnuCoArrays.pdf">source</a>)</p>
            <p>single node performance can be subpar compared to MPI (<a href="https://fortran-lang.discourse.group/t/coarrays-not-ready-for-prime-time/2715">Source</a>)</p>
            <p>More to come...</p>
         </div>

        <hr>
        <div class="footer">
            <p>Content first published: 25 Feb 2023 &nbsp;&nbsp;&nbsp; Content last modified: 25 Feb 2023</p>
            <p><a href="mailto:edward_yang_125@hotmail.com"><img src="/static/logos/email.png"> Email</a>&nbsp;&nbsp;&nbsp; <a href="https://www.github.com/edoyango"><img src="/static/logos/github.png"> Github</a>&nbsp;&nbsp;&nbsp; <a href="https://www.linkedin.com/in/edward-yang-a0a9941b1"><img src="/static/logos/linkedin.png"> LinkedIn</a></p>
        </div>
        
    </body>
</html>
