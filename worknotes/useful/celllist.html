<!doctype html>
<html>
    <head>
        <title>Ed Space - Worknotes</title>
        <link href="/css/general.css" rel="stylesheet">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
        <link href="/css/fortran-syntax.css" rel="stylesheet">
        <link href="/css/cpp-syntax.css" rel="stylesheet">
    </head>
    <body>
    
        <!-- Top navigation bar -->
        <nav class="navbar navbar-default sticky-top">
            <div class="container-fluid">
                <ul class="nav navbar-nav">
                    <li class="nav-item"><a href="/index.html">Home</a></li>
                    <li class="nav-item"><a href="/about.html">About Me</a></li>
                    <li class="nav-item active"><a href="/worknotes/index.html">Work Notes</a></li>
                    <li class="nav-item"><a href="/trips/index.html">Trips</a></li>
                    <li class="nav-item"><a href="/apps/index.html">Web Tools</a></li>
                  </ul>
            </div>
        </nav>
        
        <div class="normalwidth">
            <h1>Search for pairs of points within fixed cutoff distance with a Cell List algorithm</h1>
            <p>This is an improvement to the <a href="dsearch.html">direct search</a> algorithm for searching for pairs of points within a cutoff distance. It uses a grid of cells whose side-length is equal to the specified cutoff distance.</p>
            <p>This is beneficial to performance since for any given point, all its neighbours are guaranteed to be within its own cell, or in adjacent cells. This means that instead of performing a comparison with all other points, comparisons only need to be made to points in the same or adjacent cells.</p>
            <p>This results in O(N) time, assuming the grid cells or overall grid size, is resized to suit the number of points.</p>
            <p>The below Fortran code is a relatively naive way to implement it. It looks like how someone trying it for the first time might attempt the implementation. Other pages will demonstrate how the algorithm can be sped up.</p>
            <p>The main steps are:</p>
            <ol>
                <li>Determine the min/max extents of the grid (based on point positions).</li>
                <li>Map points to grid.</li>
                <li>Sweep through the cells to find pairs.</li>
            </ol>
            <p>The interface to the code looks similar to the direct search version, with the addition of a <code>maxpcell</code> variable that needs to be added to size the grid array.</p>
            <p>Download: <!--<a href="samples/sample.cu" download="sample.cu"><img src="/static/logos/cpp.svg" height="32px"></a>--> <a href="samples/sample.cuf" download="sample.cuf"><img src="/static/logos/Fortran.svg" height="32px"></a></p>
            <h2>C++</h2>
            <pre><code>Coming soon</code></pre>
            <h2>Fortran</h2>
            <pre><code><span class="fcomment"><span class="fcomment">!</span> Module to perform direct search for pairs of points within a fixed cutoff.</span>
<span class="fcomment">! cellList subroutine</span>
<span class="fcomment">!   dim:      An integer defining dimension of the coordinates.</span>
<span class="fcomment">!   npoints:  An integer with number of points.</span>
<span class="fcomment">!   maxpercell: An integer with max number of points in a cell.</span>
<span class="fcomment">!   x:        An real/double precision array of dim x points dimension containing the list of points to find pairs of.</span>
<span class="fcomment">!   cutoff:   The distance (same type as x) which defines a pair</span>
<span class="fcomment">!   maxnpair: An integer of the maximum number of pairs expected.</span>
<span class="fcomment">!   npairs:   An integer with the number of pairs found.</span>
<span class="fcomment">!   pair_i:   An integer array of maxnpairs length with the left-sided" point in a pair.</span>
<span class="fcomment">!   pair_j:   An integer array of maxnpairs length with the right-sided" point in a pair.</span>

<span class="fstd">module</span> cellList_m

   <span class="fstd">use</span> iso_fortran_env, <span class="fstd"></span>only</span>: error_unit

   <span class="fstd">private</span>

   <span class="fstd">interface</span> coordsToCell
      <span class="fstd">module</span> procedure coordsToCell_sp, coordsToCell_dp
   <span class="fstd">end</span> <span class="fstd">interface</span>

   <span class="fstd">interface</span> cellList
      <span class="fstd">module</span> procedure cellList_sp, cellList_dp
   <span class="fstd">end</span> <span class="fstd">interface</span> cellList

   <span class="fstd">public</span>:: cellList

<span class="fstd">contains</span>

   <span class="fcomment">!---------------------------------------------------------------------------</span>
   <span class="fstd">function</span> coordsToCell_sp(dim, xi, minx, cutoff) result(icell)

      <span class="fstd">implicit</span> <span class="fstd">none</span>
      <span class="fstd">real</span>, <span class="fstd"><span class="fstd">intent</span></span>(<span class="fstd">in</span>):: xi(dim), minx(3), cutoff
      <span class="fstd">integer</span>, <span class="fstd"><span class="fstd">intent</span></span>(<span class="fstd">in</span>):: dim
      <span class="fstd">integer</span>:: icell(3)

      icell(1:dim) = int((xi(:) - minx(1:dim))/cutoff) + 1
      <span class="fstd">if</span> (dim == 2) icell(3) = 1

   <span class="fstd">end</span> <span class="fstd">function</span> coordsToCell_sp

   <span class="fcomment">!</span>---------------------------------------------------------------------------
   <span class="fstd">function</span> coordsToCell_dp(dim, xi, minx, cutoff) result(icell)

      <span class="fstd">implicit</span> <span class="fstd">none</span>
      <span class="fstd">double precision</span>, <span class="fstd"><span class="fstd">intent</span></span>(<span class="fstd">in</span>):: xi(dim), minx(3), cutoff
      <span class="fstd">integer</span>, <span class="fstd"><span class="fstd">intent</span></span>(<span class="fstd">in</span>):: dim
      <span class="fstd">integer</span>:: icell(3)

      icell(1:dim) = int((xi(:) - minx(1:dim))/cutoff) + 1
      <span class="fstd">if</span> (dim == 2) icell(3) = 1

   <span class="fstd">end</span> <span class="fstd">function</span> coordsToCell_dp

   <span class="fcomment">!</span>---------------------------------------------------------------------------
   <span class="fstd">subroutine</span> cellList_sp(dim, npoints, maxpercell, x, cutoff, maxnpair, npairs, pair_i, pair_j)

      <span class="fstd">implicit</span> <span class="fstd">none</span>
      <span class="fstd">integer</span>, <span class="fstd"><span class="fstd">intent</span></span>(<span class="fstd">in</span>):: dim, npoints, maxnpair, maxpercell
      <span class="fstd">real</span>, <span class="fstd"><span class="fstd">intent</span></span>(<span class="fstd">in</span>):: x(dim, npoints), cutoff
      <span class="fstd">integer</span>, <span class="fstd"><span class="fstd">intent</span></span>(out)::  npairs, pair_i(maxnpair), pair_j(maxnpair)
      <span class="fstd">integer</span>:: i, j, k, ngridx(3), icell(3), xi, yi, zi, jcell(3)
      <span class="fstd">real</span>:: r2, minx(3), maxx(3)
      <span class="fstd">integer</span>, <span class="fstd">allocatable</span>:: pincell(:, :, :), cells(:, :, :, :)

      minx(1:dim) = <span class="fintrinsic">minval</span>(x, dim=2)
      <span class="fstd">if</span> (dim == 2) minx(3) = 0.d0
      maxx(1:dim) = <span class="fintrinsic">maxval</span>(x, dim=2)
      <span class="fstd">if</span> (dim == 2) maxx(3) = 0.d0
      minx(:) = minx(:) - 2.d0*cutoff
      maxx(:) = maxx(:) + 2.d0*cutoff
      ngridx(:) = int((maxx(:) - minx(:))/cutoff) + 1
      maxx(:) = maxx(:) + ngridx(:)*cutoff

      <span class="fstd">allocate</span> (pincell(ngridx(1), ngridx(2), ngridx(3)), &
                cells(maxpercell, ngridx(1), ngridx(2), ngridx(3)))

      pincell(:, :, :) = 0

      <span class="fstd">do</span> i = 1, npoints
         icell = coordsToCell(dim, x(:, i), minx, cutoff)
         pincell(icell(1), icell(2), icell(3)) = pincell(icell(1), icell(2), icell(3)) + 1
<span class="fpp"><span class="fpp">#ifdef DEBUG</span></span>
         <span class="fstd">if</span> (pincell(icell(1), icell(2), icell(3)) > maxpercell) <span class="fstd">then</span>
            <span class="fstd">write</span> (error_unit, <span class="fstring"><span class="fstring">'(A, 3(I2, 1x), A)'</span></span>) <span class="fstring"><span class="fstring">'Number of particles in cell '</span></span>, &
   icell(1), icell(2), icell(3), <span class="fstring"><span class="fstring">' exceeds the input maxpercell <span class="fstd">value</span>.'</span></span>
            <span class="fstd">write</span> (error_unit, <span class="fstring"><span class="fstring"><span class="fstring">'(A)'</span></span></span>) <span class="fstring"><span class="fstring">'Terminating...'</span></span>
            error <span class="fstd">stop</span> 1
         <span class="fstd">end</span> <span class="fstd">if</span>
<span class="fpp"><span class="fpp"><span class="fpp">#<span class="fstd">endif</span></span></span></span>
         cells(pincell(icell(1), icell(2), icell(3)), icell(1), icell(2), icell(3)) = i
      <span class="fstd">end</span> <span class="fstd">do</span>

      npairs = 0
      <span class="fstd">do</span> i = 1, npoints
         icell(:) = coordsToCell(dim, x(:, i), minx, cutoff)
         <span class="fstd">do</span> xi = -1, 1
            jcell(1) = icell(1) + xi
            <span class="fstd">do</span> yi = -1, 1
               jcell(2) = icell(2) + yi
               <span class="fstd">do</span> zi = -1, 1
                  jcell(3) = icell(3) + zi
                  <span class="fstd">do</span> k = 1, pincell(jcell(1), jcell(2), jcell(3))
                     j = cells(k, jcell(1), jcell(2), jcell(3))
                     <span class="fstd">if</span> (j > i) <span class="fstd">then</span>
                        r2 = <span class="fintrinsic">sum</span>((x(:, i) - x(:, j))**2)
                        <span class="fstd">if</span> (r2 <= cutoff**2) <span class="fstd">then</span>
                           npairs = npairs + 1
                           pair_i(npairs) = i
                           pair_j(npairs) = j
                        <span class="fstd">end</span> <span class="fstd">if</span>
                     <span class="fstd">end</span> <span class="fstd">if</span>
                  <span class="fstd">end</span> <span class="fstd">do</span>
               <span class="fstd">end</span> <span class="fstd">do</span>
            <span class="fstd">end</span> <span class="fstd">do</span>
         <span class="fstd">end</span> <span class="fstd">do</span>
      <span class="fstd">end</span> <span class="fstd">do</span>

   <span class="fstd">end</span> <span class="fstd">subroutine</span> cellList_sp

   <span class="fcomment">!</span>---------------------------------------------------------------------------
   <span class="fstd">subroutine</span> cellList_dp(dim, npoints, maxpercell, x, cutoff, maxnpair, npairs, pair_i, pair_j)

      <span class="fstd">implicit</span> <span class="fstd">none</span>
      <span class="fstd">integer</span>, <span class="fstd"><span class="fstd">intent</span></span>(<span class="fstd">in</span>):: dim, npoints, maxnpair, maxpercell
      <span class="fstd">double precision</span>, <span class="fstd"><span class="fstd">intent</span></span>(<span class="fstd">in</span>):: x(dim, npoints), cutoff
      <span class="fstd">integer</span>, <span class="fstd"><span class="fstd">intent</span></span>(out)::  npairs, pair_i(maxnpair), pair_j(maxnpair)
      <span class="fstd">integer</span>:: i, j, k, ngridx(3), icell(3), xi, yi, zi, jcell(3)
      <span class="fstd">double precision</span>:: r2, minx(3), maxx(3)
      <span class="fstd">integer</span>, <span class="fstd">allocatable</span>:: pincell(:, :, :), cells(:, :, :, :)

      minx(1:dim) = <span class="fintrinsic">minval</span>(x, dim=2)
      <span class="fstd">if</span> (dim == 2) minx(3) = 0.d0
      maxx(1:dim) = <span class="fintrinsic">maxval</span>(x, dim=2)
      <span class="fstd">if</span> (dim == 2) maxx(3) = 0.d0
      minx(:) = minx(:) - 2.d0*cutoff
      maxx(:) = maxx(:) + 2.d0*cutoff
      ngridx(:) = int((maxx(:) - minx(:))/cutoff) + 1
      maxx(:) = maxx(:) + ngridx(:)*cutoff

      <span class="fstd">allocate</span> (pincell(ngridx(1), ngridx(2), ngridx(3)), &
                cells(maxpercell, ngridx(1), ngridx(2), ngridx(3)))

      pincell(:, :, :) = 0

      <span class="fstd">do</span> i = 1, npoints
         icell = coordsToCell(dim, x(:, i), minx, cutoff)
         pincell(icell(1), icell(2), icell(3)) = pincell(icell(1), icell(2), icell(3)) + 1
<span class="fpp"><span class="fpp">#ifdef DEBUG</span></span>
         <span class="fstd">if</span> (pincell(icell(1), icell(2), icell(3)) > maxpercell) <span class="fstd">then</span>
            <span class="fstd">write</span> (error_unit, <span class="fstring"><span class="fstring">'(A, 3(I2, 1x), A)'</span></span>) <span class="fstring"><span class="fstring">'Number of particles in cell '</span></span>, &
   icell(1), icell(2), icell(3), <span class="fstring"><span class="fstring">' exceeds the input maxpercell <span class="fstd">value</span>.'</span></span>
            <span class="fstd">write</span> (error_unit, <span class="fstring"><span class="fstring"><span class="fstring">'(A)'</span></span></span>) <span class="fstring"><span class="fstring">'Terminating...'</span></span>
            error <span class="fstd">stop</span> 1
         <span class="fstd">end</span> <span class="fstd">if</span>
<span class="fpp">#endif</span>
         cells(pincell(icell(1), icell(2), icell(3)), icell(1), icell(2), icell(3)) = i
      <span class="fstd">end</span> <span class="fstd">do</span>

      npairs = 0
      <span class="fstd">do</span> i = 1, npoints
         icell(:) = coordsToCell(dim, x(:, i), minx, cutoff)
         <span class="fstd">do</span> xi = -1, 1
            jcell(1) = icell(1) + xi
            <span class="fstd">do</span> yi = -1, 1
               jcell(2) = icell(2) + yi
               <span class="fstd">do</span> zi = -1, 1
                  jcell(3) = icell(3) + zi
                  <span class="fstd">do</span> k = 1, pincell(jcell(1), jcell(2), jcell(3))
                     j = cells(k, jcell(1), jcell(2), jcell(3))
                     <span class="fstd">if</span> (j > i) <span class="fstd">then</span>
                        r2 = <span class="fintrinsic">sum</span>((x(:, i) - x(:, j))**2)
                        <span class="fstd">if</span> (r2 <= cutoff**2) <span class="fstd">then</span>
                           npairs = npairs + 1
                           pair_i(npairs) = i
                           pair_j(npairs) = j
                        <span class="fstd">end</span> <span class="fstd">if</span>
                     <span class="fstd">end</span> <span class="fstd">if</span>
                  <span class="fstd">end</span> <span class="fstd">do</span>
               <span class="fstd">end</span> <span class="fstd">do</span>
            <span class="fstd">end</span> <span class="fstd">do</span>
         <span class="fstd">end</span> <span class="fstd">do</span>
      <span class="fstd">end</span> <span class="fstd">do</span>

   <span class="fstd">end</span> <span class="fstd">subroutine</span> cellList_dp

<span class="fstd">end</span> <span class="fstd">module</span> cellList_m

<span class="fpp">#ifndef NOMAIN</span>
<span class="fstd">program</span> main

   <span class="fstd">use</span> cellList_m, only: cellList

   <span class="fstd">implicit</span> <span class="fstd">none</span>
   <span class="fstd">integer</span>, <span class="fstd">parameter</span>:: n = 100, dim = 3, maxnpair = 60*n <span class="fcomment"><span class="fcomment">!</span> estimated using</span>
   <span class="fcomment"><span class="fcomment">!</span> 2x the coaxial spacing if the points were arranged in a square</span>
   <span class="fstd">double precision</span>, <span class="fstd">parameter</span>:: cutoff = 2*n**(-1.d0/dim)
   <span class="fstd">double precision</span>:: x(dim, n)
   <span class="fstd">integer</span>:: pair_i(maxnpair), pair_j(maxnpair), npairs, startpos, i, j, k, endpos(n)

   <span class="fcomment"><span class="fcomment">!</span> initialize positions with pseudo-random numbers</span>
   <span class="fstd">call</span> <span class="fintrinsic">random_number</span>(x)

   <span class="fcomment"><span class="fcomment">!</span> finding pairs</span>
   <span class="fstd">call</span> cellList(dim, n, 27, x, cutoff, maxnpair, npairs, pair_i, pair_j)

   <span class="fstd">write</span> (*, <span class="fstring"><span class="fstring"><span class="fstring">'(A)'</span></span></span>) <span class="fstring">'Executing cellList'</span>
   <span class="fstd">write</span> (*, <span class="fstring">'(2x, A,I4,A)'</span>) <span class="fstring">'Found '</span>, npairs, <span class="fstring">' pairs'</span>
   <span class="fstd">write</span> (*, <span class="fstring"><span class="fstring">'(2x, A)'</span></span>) <span class="fstring">'First and last 5 pairs of points found:'</span>
   <span class="fstd">write</span> (*, <span class="fstring">'(2x, 4(A4, 1x))'</span>) <span class="fstring">'Pair'</span>, <span class="fstring">'i'</span>, <span class="fstring">'j'</span>
   <span class="fstd">do</span> k = 1, npairs
      <span class="fstd">if</span> (k <= 5 <span class="flog">.or.</span> k > npairs - 4) write (*, <span class="fstring">'(2x, 3(I4, 1x))'</span>) k, pair_i(k), pair_j(k)
      <span class="fstd">if</span> (k == 6) write (*, <span class="fstring"><span class="fstring">'(2x, A)'</span></span>) <span class="fstring">'...'</span>
   <span class="fstd">end</span> <span class="fstd">do</span>

<span class="fstd">end</span> <span class="fstd">program</span> main
<span class="fpp">#endif</span></code></pre>
        </div>

        <hr>
        <div class="footer">
            <p>Content first published: 12 Feb 2023 &nbsp;&nbsp;&nbsp; Content last modified: 12 Feb 2023</p>
            <p><a href="mailto:edward_yang_125@hotmail.com"><img src="/static/logos/email.png"> Email</a>&nbsp;&nbsp;&nbsp; <a href="https://www.github.com/edoyango"><img src="/static/logos/github.png"> Github</a>&nbsp;&nbsp;&nbsp; <a href="https://www.linkedin.com/in/edward-yang-a0a9941b1"><img src="/static/logos/linkedin.png"> LinkedIn</a></p>
        </div>
        
    </body>
</html>
