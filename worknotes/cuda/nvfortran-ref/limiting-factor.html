<!doctype html>
<html>
	<head>
		<title>Ed Space - Worknotes - CUDA</title>
		<link href="/css/general.css" rel="stylesheet">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
		<link href="/css/fortran-syntax.css" rel="stylesheet">
	</head>
	<body>
	
		<!-- Top navigation bar -->
		<nav class="navbar navbar-default sticky-top">
			<div class="container-fluid">
				<ul class="nav navbar-nav">
					<li class="nav-item"><a href="/index.html">Home</a></li>
					<li class="nav-item"><a href="/about.html">About Me</a></li>
					<li class="nav-item active"><a href="/worknotes/index.html">Work Notes</a></li>
					<li class="nav-item"><a href="/trips/index.html">Trips</a></li>
					<li class="nav-item"><a href="/apps/index.html">Web Tools</a></li>
		  		</ul>
			</div>
		</nav>
		
		<div class="normalwidth">
			<h1>limitingFactor</h1>
			<p>Code to test whether computation or memory transfer is the bottleneck. Compiled program intended to be run with <code>nvprof</code>.</p>
			<p>The book demonstrates the effect of compiling with <code>-Mcuda=fastmath</code>, which shows a significant speedup in the "base" and "math" kernels (note they use very old C2050 and K20 GPUs).</p>
			<p><a href="limitingFactor.cuf" download="limitingFactor.cuf">Download link</a></p>
            <pre><code><span class="fstd">module</span> kernel_m
<span class="fstd">contains</span>

    <span class="fnv">attributes</span>(<span class="fnv">global</span>) <span class="fstd">subroutine</span> base(a,b)
        <span class="fstd">real</span>:: a(*), b(*)
        <span class="fstd">integer</span>:: i
        i = (<span class="fnv">blockIdx</span>%x-1) * <span class="fnv">blockDim</span>%x + <span class="fnv">threadIdx</span>%x
        a(i) = sin(b(i))
    <span class="fstd">end</span> <span class="fstd">subroutine</span> base

    <span class="fnv">attributes</span>(<span class="fnv">global</span>) <span class="fstd">subroutine</span> memory(a,b)
        <span class="fstd">real</span>:: a(*), b(*)
        <span class="fstd">integer</span>:: i
        i = (<span class="fnv">blockIdx</span>%x-1) * <span class="fnv">blockDim</span>%x + <span class="fnv">threadIdx</span>%x
        a(i) = b(i)
    <span class="fstd">end</span> <span class="fstd">subroutine</span> memory

    <span class="fnv">attributes</span>(<span class="fnv">global</span>) <span class="fstd">subroutine</span> math(a, b, flag)
        <span class="fstd">real</span>:: a(*)
        <span class="fstd">real</span>, <span class="fstd">value</span>:: b
        <span class="fstd">integer</span>, <span class="fstd">value</span>:: flag
        <span class="fstd">real</span>:: v
        <span class="fstd">integer</span>:: i
        i = (<span class="fnv">blockIdx</span>%x-1)*<span class="fnv">blockDim</span>%x + <span class="fnv">threadIdx</span>%x
        v = sin(b)
        <span class="fstd">if</span> (v*flag == 1) a(i) = v
    <span class="fstd">end</span> <span class="fstd">subroutine</span> math

<span class="fstd">end</span> <span class="fstd">module</span> kernel_m

<span class="fstd">program</span> limitingFactor

    <span class="fstd">use</span> cudafor
    <span class="fstd">use</span> kernel_m 

    <span class="fstd">implicit</span> <span class="fstd">none</span>
    <span class="fstd">integer</span>, <span class="fstd">parameter</span>:: n=8*1024*1024, blockSize=256
    <span class="fstd">real</span>:: a(n)
    <span class="fstd">real</span>, <span class="fnv">device</span>:: a_d(n), b_d(n)    

    b_d = 1.    

    <span class="fstd">call</span> base<span class="fnv"><span class="fnv"><span class="fnv">&lt;&lt;&lt;n/blockSize, blockSize&gt;&gt;&gt;</span></span></span>(a_d, b_d)
    <span class="fstd">call</span> memory<span class="fnv"><span class="fnv"><span class="fnv">&lt;&lt;&lt;n/blockSize, blockSize&gt;&gt;&gt;</span></span></span>(a_d, b_d)
    <span class="fstd">call</span> math<span class="fnv"><span class="fnv"><span class="fnv">&lt;&lt;&lt;n/blockSize, blockSize&gt;&gt;&gt;</span></span></span>(a_d, 1.0, 0)

    a = a_d

    <span class="fstd">write</span>(*,*) a(1)
			
<span class="fstd">end</span> <span class="fstd">program</span> limitingFactor</code></pre>
		</div>

		<hr>
		<div class="footer">
			<p>Content first published: 25 Jan 2023 &nbsp;&nbsp;&nbsp; Content last modified: 25 Jan 2023</p>
			<p><a href="mailto:edward_yang_125@hotmail.com"><img src="/static/logos/email.png"> Email</a>&nbsp;&nbsp;&nbsp; <a href="https://www.github.com/edoyango"><img src="/static/logos/github.png"> Github</a>&nbsp;&nbsp;&nbsp; <a href="https://www.linkedin.com/in/edward-yang-a0a9941b1"><img src="/static/logos/linkedin.png"> LinkedIn</a></p>
		</div>
		
	</body>
</html>
