<!doctype html>
<html>
    <head>
        <title>Ed Space - Worknotes - CUDA</title>
        <link href="/css/general.css" rel="stylesheet">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
        <link href="/css/fortran-syntax.css" rel="stylesheet">
    </head>
    <body>
    
        <!-- Top navigation bar -->
        <nav class="navbar navbar-default sticky-top">
            <div class="container-fluid">
                <ul class="nav navbar-nav">
                    <li class="nav-item"><a href="/index.html">Home</a></li>
                    <li class="nav-item"><a href="/about.html">About Me</a></li>
                    <li class="nav-item active"><a href="/worknotes/index.html">Work Notes</a></li>
                    <li class="nav-item"><a href="/trips/index.html">Trips</a></li>
                    <li class="nav-item"><a href="/apps/index.html">Web Tools</a></li>
                  </ul>
            </div>
        </nav>
        
        <div class="normalwidth">
            <h1>mpiDeviceUtil</h1>
            <p>Basic module to assign MPI processes to unique GPUs. This is modified from the code in the book to use <code>MPI_ALLGATHER</code>, an explicit definition of the <code>quicksort</code> function, and the use of <code>hostnm</code> Fortran intrinsic function instead of the <code>MPI_GET_PROCESSOR_NAME</code>. <code>MPI_GET_PROCESSOR_NAME</code> doesn't return a unique name for nodes with the same CPUs.</p>
            <p><a href="samples/mpiDeviceUtil.cuf" download="mpiDeviceUtil.cuf">Download link</a></p>
            <pre><code><span class="fstd">module</span> mpiDeviceUtil
<span class="fstd">contains</span>

    <span class="fstd">subroutine</span> assignDevice(procid, numprocs, dev)

        <span class="fstd">use</span> mpi
        <span class="fstd">use</span> <span class="fnv">cudafor</span>

        <span class="fstd">implicit</span> <span class="fstd">none</span>
        <span class="fstd">integer</span>:: numprocs, procid, dev
        character(<span class="fstd">len</span>=100), <span class="fstd">allocatable</span>:: hosts(:)
        character(<span class="fstd">len</span>=100):: hostname
        <span class="fstd">integer</span>:: namelength, color, i
        <span class="fstd">integer</span>:: newComm, newProcid, ierr
        <span class="fstd">logical</span>:: mpiInitialized

        <span class="fcomment">! <span class="fstd">allocate</span> array of hostnames</span>
        <span class="fstd">allocate</span>(hosts(0:numprocs-1))

        <span class="fcomment">! every process collects the hostname of all the nodes</span>
        <span class="fstd">call</span> <span class="fintrinsic">hostnm</span>(hostname)

        <span class="fstd">call</span> <span class="fmpi">MPI_ALLGATHER</span>(hostname, 100, MPI_CHARACTER, hosts, 100, MPI_CHARACTER, <span class="fmpi">MPI_COMM_WORLD</span>, ierr)

        <span class="fstd">call</span> <span class="fmpi">MPI_BARRIER</span>(<span class="fmpi">MPI_COMM_WORLD</span>,ierr)

        <span class="fcomment">! sort the list of names</span>
        <span class="fstd">call</span> quicksort(hosts, 100, 1, numprocs)

        <span class="fstd">call</span> <span class="fmpi">MPI_BARRIER</span>(<span class="fmpi">MPI_COMM_WORLD</span>,ierr)

        <span class="fcomment">! assign the same color to the same node</span>
        color = 0
        <span class="fstd">do</span> i = 0, numprocs-1
            <span class="fstd">if</span> (i > 0) <span class="fstd">then</span>
                <span class="fstd">if</span> ( hosts(i-1) /= hosts(i) ) color = color + 1
            <span class="fstd">end</span> <span class="fstd">if</span>
            <span class="fstd">if</span> ( hostname <= hosts(i) ) <span class="fstd">exit</span>
        <span class="fstd">end</span> <span class="fstd">do</span>

        <span class="fstd">call</span> <span class="fmpi">MPI_COMM_SPLIT</span>(<span class="fmpi">MPI_COMM_WORLD</span>, color, 0, newComm, ierr)
        <span class="fstd">call</span> <span class="fmpi">MPI_COMM_RANK</span>(newComm, newProcid, ierr)

        dev = newProcid
        ierr = <span class="fnv">cudaSetDevice</span>(dev)

        <span class="fstd">deallocate</span>(hosts)

    <span class="fstd">end</span> <span class="fstd">subroutine</span> assignDevice

    <span class="fcomment">! quicksort.f -*-f90-*-</span>
    <span class="fcomment">! Author: t-nissie</span>
    <span class="fcomment">! License: GPLv3</span>
    <span class="fcomment">! Gist: https://gist.github.com/t-nissie/479f0f16966925fa29ea</span>
    <span class="fcomment">!!</span>
    recursive <span class="fstd">subroutine</span> quicksort(a, strlen, first, last)
    
        <span class="fstd">implicit</span> <span class="fstd">none</span>
        <span class="fstd">integer</span>, intent(in):: strlen, first, last
        character(strlen), intent(inout):: a(*)
        character(strlen)::  x, t
        <span class="fstd">integer</span>:: i, j

        x = a( (first+last) / 2 )
        i = first
        j = last
        <span class="fstd">do</span>
           <span class="fstd">do</span> <span class="fstd">while</span> (a(i) < x)
              i=i+1
           <span class="fstd">end</span> <span class="fstd">do</span>
           <span class="fstd">do</span> <span class="fstd">while</span> (x < a(j))
              j=j-1
           <span class="fstd">end</span> <span class="fstd">do</span>
           <span class="fstd">if</span> (i >= j) <span class="fstd">exit</span>
           t = a(i);  a(i) = a(j);  a(j) = t
           i=i+1
           j=j-1
        <span class="fstd">end</span> <span class="fstd">do</span>
        <span class="fstd">if</span> (first < i-1) <span class="fstd">call</span> quicksort(a, strlen, first, i-1)
        <span class="fstd">if</span> (j+1 < last)  <span class="fstd">call</span> quicksort(a, strlen, j+1, last)

    <span class="fstd">end</span> <span class="fstd">subroutine</span> quicksort

<span class="fstd">end</span> <span class="fstd">module</span> mpiDeviceUtil

<span class="fstd">program</span> main

    <span class="fstd">use</span> mpi
    <span class="fstd">use</span> <span class="fnv">cudafor</span>
    <span class="fstd">use</span> mpiDeviceUtil

    <span class="fstd">implicit</span> <span class="fstd">none</span>
    <span class="fstd">integer</span>, <span class="fstd">parameter</span>:: n = 1024*1024
    <span class="fcomment">! mpi</span>
    character(<span class="fstd">len</span>=100):: hostname
    <span class="fstd">integer</span>:: procid, numprocs, ierr, namelength
    <span class="fcomment">! <span class="fnv">device</span></span>
    <span class="fstd">type</span>(<span class="fnv">cudaDeviceProp</span>):: prop
    <span class="fstd">integer</span>(<span class="fnv">int_ptr_kind</span>()):: freeB, totalB, freeA, totalA
    <span class="fstd">real</span>, <span class="fnv">device</span>, <span class="fstd">allocatable</span>:: d(:)
    <span class="fstd">integer</span>:: deviceID, i, istat

    <span class="fstd">call</span> <span class="fmpi">MPI_INIT</span>(ierr)
    <span class="fstd">call</span> <span class="fmpi">MPI_COMM_RANK</span>(<span class="fmpi">MPI_COMM_WORLD</span>, procid, ierr)
    <span class="fstd">call</span> <span class="fmpi">MPI_COMM_SIZE</span>(<span class="fmpi">MPI_COMM_WORLD</span>, numprocs, ierr)

    <span class="fcomment">! get and set unique <span class="fnv">device</span></span>
    <span class="fstd">call</span> assignDevice(procid, numprocs, deviceID)

    <span class="fcomment">! print hostname and <span class="fnv">device</span> ID for each rank</span>
    <span class="fstd">call</span> <span class="fintrinsic">hostnm</span>(hostname)
    <span class="fstd">do</span> i = 0, numprocs-1
        <span class="fstd">call</span> <span class="fmpi">MPI_BARRIER</span>(<span class="fmpi">MPI_COMM_WORLD</span>, ierr)
        <span class="fstd">if</span> (i == procid) <span class="fstd">write</span>(*,<span class="fstring">"(<span class="fstring">'['</span>,i0,<span class="fstring">'] host: '</span>, a, <span class="fstring">',  <span class="fnv">device</span>: '</span>, i0)"</span>) procid, <span class="fintrinsic">trim</span>(hostname), deviceID
    <span class="fstd">end</span> <span class="fstd">do</span>

    <span class="fcomment">! get memory <span class="fstd">use</span> before large allocations</span>
    <span class="fstd">call</span> <span class="fmpi">MPI_BARRIER</span>(<span class="fmpi">MPI_COMM_WORLD</span>, ierr)
    istat = <span class="fnv">cudaMemGetInfo</span>(freeB, totalB)

    <span class="fcomment">! <span class="fstd">allocate</span> memory on each <span class="fnv">device</span></span>
    <span class="fstd">call</span> <span class="fmpi">MPI_BARRIER</span>(<span class="fmpi">MPI_COMM_WORLD</span>, ierr)
    <span class="fstd">allocate</span>(d(n))

    <span class="fcomment">! get free memory after allocation</span>
    <span class="fstd">call</span> <span class="fmpi">MPI_BARRIER</span>(<span class="fmpi">MPI_COMM_WORLD</span>, ierr)
    istat = <span class="fnv">cudaMemGetInfo</span>(freeA, totalA)

    <span class="fstd">do</span> i = 0, numprocs-1
        <span class="fstd">call</span> <span class="fmpi">MPI_BARRIER</span>(<span class="fmpi">MPI_COMM_WORLD</span>, ierr)
        <span class="fstd">if</span> (i == procid) <span class="fstd">write</span>(*,<span class="fstring">"(<span class="fstring">'  ['</span>, i0, <span class="fstring">'] '</span>, <span class="fstring">'<span class="fnv">device</span> arrays <span class="fintrinsic">allocated</span>: '</span>, i0)"</span>) procid, (freeB-freeA)/n/4
    <span class="fstd">end</span> <span class="fstd">do</span>

    <span class="fstd">deallocate</span>(d)

    <span class="fstd">call</span> <span class="fmpi">MPI_FINALIZE</span>(ierr)

<span class="fstd">end</span> <span class="fstd">program</span> main</code></pre>
        </div>

        <hr>
        <div class="footer">
            <p>Content first published: 28 Jan 2023 &nbsp;&nbsp;&nbsp; Content last modified: 28 Jan 2023</p>
            <p><a href="mailto:edward_yang_125@hotmail.com"><img src="/static/logos/email.png"> Email</a>&nbsp;&nbsp;&nbsp; <a href="https://www.github.com/edoyango"><img src="/static/logos/github.png"> Github</a>&nbsp;&nbsp;&nbsp; <a href="https://www.linkedin.com/in/edward-yang-a0a9941b1"><img src="/static/logos/linkedin.png"> LinkedIn</a></p>
        </div>
        
    </body>
</html>
