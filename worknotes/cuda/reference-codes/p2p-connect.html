<!doctype html>
<html>
    <head>
        <title>Ed Space - Worknotes - CUDA</title>
        <link href="/css/general.css" rel="stylesheet">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
        <link href="/css/fortran-syntax.css" rel="stylesheet">
        <link href="/css/cpp-syntax.css" rel="stylesheet">
    </head>
    <body>
    
        <!-- Top navigation bar -->
        <nav class="navbar navbar-default sticky-top">
            <div class="container-fluid">
                <ul class="nav navbar-nav">
                    <li class="nav-item"><a href="/index.html">Home</a></li>
                    <li class="nav-item"><a href="/about.html">About Me</a></li>
                    <li class="nav-item active"><a href="/worknotes/index.html">Work Notes</a></li>
                    <li class="nav-item"><a href="/trips/index.html">Trips</a></li>
                    <li class="nav-item"><a href="/apps/index.html">Web Tools</a></li>
                  </ul>
            </div>
        </nav>
        
        <div class="normalwidth">
            <h1>checkP2pAccess</h1>
            <p>Tool to check peer-to-peer connectivity between GPUs connected to the motherboard.</p>
            <p>Download: <a href="samples/checkP2pAccess.cu" download="checkP2pAccess.cu"><img src="/static/logos/cpp.svg" height="32px"></a> <a href="samples/checkP2pAccess.cuf" download="checkP2pAccess.cuf"><img src="/static/logos/Fortran.svg" height="32px"></a></p>
			<h2>C++</h2>
            <pre><code><span class="cpp">#include &lt;stdio.h&gt;</span>

<span class="cstd">int</span> main() {

    <span class="cstd">int</span> nDevices;
    <span class="cnv">cudaGetDeviceCount</span>(&nDevices);
    printf(<span class="cstring">"Number of CUDA-capable devices: %d\n"</span>, nDevices);

    <span class="cnv">cudaDeviceProp</span> prop;
    <span class="cstd">for</span> (<span class="cstd">int</span> i = 0; i &lt; nDevices; ++i) {
        <span class="cnv">cudaGetDeviceProperties</span>(&prop, i);
        printf(<span class="cstring">"Device %d: %s\n"</span>, i, prop.name);
    }

    <span class="cstd">int</span> p2pOK[nDevices][nDevices];
    <span class="cstd">for</span> (<span class="cstd">int</span> i = 0; i &lt; nDevices; ++i) {
        <span class="cstd">for</span> (<span class="cstd">int</span> j = i+1; j &lt; nDevices; ++j) {
            <span class="cnv">cudaDeviceCanAccessPeer</span>(&p2pOK[i][j], i, j);
            p2pOK[j][i] = p2pOK[i][j];
        }
    }
    printf(<span class="cstring"><span class="cstring"><span class="cstring">"\n"</span></span></span>);

    <span class="cstd">for</span> (<span class="cstd">int</span> i = 0; i &lt; nDevices; ++i) {
        printf(<span class="cstring">"   %3d"</span>, i);
    }
    printf(<span class="cstring"><span class="cstring"><span class="cstring">"\n"</span></span></span>);

    <span class="cstd">for</span> (<span class="cstd">int</span> j = 0; j &lt; nDevices; ++j) {
        printf(<span class="cstring">"%3d"</span>,j);
        <span class="cstd">for</span> (<span class="cstd">int</span> i = 0; i &lt; nDevices; ++i) {
            <span class="cstd">if</span> (i==j) {
                printf(<span class="cstring">"  -   "</span>);
            } <span class="cstd">else</span> <span class="cstd">if</span> (p2pOK[i][j] == 1) {
                printf(<span class="cstring">"  Y   "</span>);
            } <span class="cstd">else</span> {
                printf(<span class="cstring">"      "</span>);
            }
        }
        printf(<span class="cstring"><span class="cstring"><span class="cstring">"\n"</span></span></span>);
    }
}</code></pre>
            <h2>Fortran</h2>
            <pre><code><span class="fstd">program</span> checkP2pAccess

    <span class="fstd">use</span> <span class="fnv">cudafor</span>

    <span class="fstd">implicit</span> <span class="fstd">none</span>
    <span class="fstd">integer</span>, <span class="fstd">allocatable</span>:: p2pOK(:,:)
    <span class="fstd">integer</span>:: nDevices, i, j, istat
    <span class="fstd">type</span> (<span class="fnv">cudaDeviceProp</span>):: prop

    istat = <span class="fnv">cudaGetDeviceCount</span>(nDevices)
    <span class="fstd">write</span>(*,<span class="fstring">"(<span class="fstring">'Number of CUDA -capable devices: '</span>, i0,/)"</span>) nDevices

    <span class="fstd">do</span> i = 0, nDevices -1
        istat = <span class="fnv">cudaGetDeviceProperties</span>(prop, i)
        <span class="fstd">write</span>(*,<span class="fstring">"(<span class="fstring">'Device '</span>, i0, <span class="fstring">': '</span>, a)"</span>) i, <span class="fintrinsic">trim</span>(prop%name)
    <span class="fstd">end</span> <span class="fstd">do</span>
    <span class="fstd">write</span>(*,*)

    <span class="fstd">allocate</span>(p2pOK (0: nDevices -1, 0: nDevices -1))
    p2pOK = 0

    <span class="fstd">do</span> j = 0, nDevices -1
        <span class="fstd">do</span> i = j+1, nDevices -1
            istat = <span class="fnv">cudaDeviceCanAccessPeer</span>(p2pOK(i,j), i, j)
            p2pOK(j,i) = p2pOK(i,j)
        <span class="fstd">end</span> <span class="fstd">do</span>
    <span class="fstd">end</span> <span class="fstd">do</span>

    <span class="fstd">do</span> i = 0, nDevices -1
        <span class="fstd">write</span>(*,<span class="fstring">"(3x,i3)"</span>, <span class="fstd">advance</span>=<span class="fstring"><span class="fstring"><span class="fstring"><span class="fstring"><span class="fstring">'no'</span></span></span></span></span>) i
    <span class="fstd">end</span> <span class="fstd">do</span>
    <span class="fstd">write</span>(*,*)

    <span class="fstd">do</span> j = 0, nDevices -1
        <span class="fstd">write</span>(*,<span class="fstring">"(i3)"</span>, <span class="fstd">advance</span>=<span class="fstring"><span class="fstring"><span class="fstring"><span class="fstring"><span class="fstring">'no'</span></span></span></span></span>) j
        <span class="fstd">do</span> i = 0, nDevices -1
            <span class="fstd">if</span> (i == j) <span class="fstd">then</span>
            <span class="fstd">write</span>(*,<span class="fstring">"(2x,<span class="fstring">'-'</span>,3x)"</span>, <span class="fstd">advance</span>=<span class="fstring"><span class="fstring"><span class="fstring"><span class="fstring"><span class="fstring">'no'</span></span></span></span></span>)
            <span class="fstd">else</span> <span class="fstd">if</span> (p2pOK(i,j) == 1) <span class="fstd">then</span>
            <span class="fstd">write</span>(*,<span class="fstring">"(2x, <span class="fstring">'Y'</span>,3x)"</span>,<span class="fstd">advance</span>=<span class="fstring"><span class="fstring"><span class="fstring"><span class="fstring"><span class="fstring">'no'</span></span></span></span></span>)
            <span class="fstd">else</span>
            <span class="fstd">write</span>(*,<span class="fstring">"(6x)"</span>,<span class="fstd">advance</span>=<span class="fstring"><span class="fstring"><span class="fstring"><span class="fstring"><span class="fstring">'no'</span></span></span></span></span>)
            <span class="fstd">end</span> <span class="fstd">if</span>
        <span class="fstd">end</span> <span class="fstd">do</span>
        <span class="fstd">write</span>(*,*)
    <span class="fstd">end</span> <span class="fstd">do</span>

<span class="fstd">end</span> <span class="fstd">program</span> checkP2pAccess</code></pre>
        </div>

        <hr>
        <div class="footer">
            <p>Content first published: 25 Jan 2023 &nbsp;&nbsp;&nbsp; Content last modified: 02 Feb 2023</p>
            <p><a href="mailto:edward_yang_125@hotmail.com"><img src="/static/logos/email.png"> Email</a>&nbsp;&nbsp;&nbsp; <a href="https://www.github.com/edoyango"><img src="/static/logos/github.png"> Github</a>&nbsp;&nbsp;&nbsp; <a href="https://www.linkedin.com/in/edward-yang-a0a9941b1"><img src="/static/logos/linkedin.png"> LinkedIn</a></p>
        </div>
        
    </body>
</html>
