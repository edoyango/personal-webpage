<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="
  Fixed-Radius Neighbour Search Using Thrust
  #

This page describes how one might implement the pair-finding algorithm described by 
  Simon Green (2010).
Many implementations of Simon&rsquo;s work exists, such as the 
  FRNN Python package.

  Why Thrust?
  #

I would argue that there is a fairly strong incentive to make GPU-accelerated codes portable across different
hardware platforms. At the time of writing, NVIDIA GPUs are becoming more challenging to get a hold of, and are
more expensive relative to their competition (i.e., AMD and Intel GPUs). Consequently, it is becoming harder to justify
writing code exclusively using the CUDA ecosystem.">
<meta name="theme-color" content="#FFFFFF">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="/worknotes/docs/cuda/frn-thrust/">
  <meta property="og:site_name" content="Ed&#39;s Space - Notes">
  <meta property="og:title" content="Fixed-Radius Neighbour Search Using Thrust">
  <meta property="og:description" content="Fixed-Radius Neighbour Search Using Thrust # This page describes how one might implement the pair-finding algorithm described by Simon Green (2010). Many implementations of Simonâ€™s work exists, such as the FRNN Python package.
Why Thrust? # I would argue that there is a fairly strong incentive to make GPU-accelerated codes portable across different hardware platforms. At the time of writing, NVIDIA GPUs are becoming more challenging to get a hold of, and are more expensive relative to their competition (i.e., AMD and Intel GPUs). Consequently, it is becoming harder to justify writing code exclusively using the CUDA ecosystem.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="docs">
    <meta property="article:modified_time" content="2025-12-01T09:11:30+11:00">
<title>Fixed-Radius Neighbour Search Using Thrust | Ed&#39;s Space - Notes</title>
<link rel="manifest" href="/worknotes/manifest.json">
<link rel="icon" href="/worknotes/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/worknotes/book.min.bbbc295605634a339d694e79de1f34bb64fb1413d11c2e8e1e95220e664378ee.css" >
  <script defer src="/worknotes/flexsearch.min.js"></script>
  <script defer src="/worknotes/en.search.min.48eb540d192c9db780915c3ca5ce500743414d181ec846194664598f9897bdc2.js" ></script>

  <script defer src="/worknotes/sw.min.97afbbb840f8817a158b86f13f6a071d4ddf793bff2b4832f0bea2832fcea52b.js" ></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/worknotes/"><span>Ed&#39;s Space - Notes</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  



  
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/f-cpp/" class="">A Basic Comparison of C&#43;&#43; vs Fortran</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-d75bf0277a78395058ee4f19eb9d8b34" class="toggle"  />
    <label for="section-d75bf0277a78395058ee4f19eb9d8b34" class="flex justify-between">
      <a role="button" class="">Investigating Manual Vectorization for SPH</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/manual-vectorization/motivation/" class="">Motivation</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/manual-vectorization/addition/" class="">Vectorizing Array Addition</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/manual-vectorization/sumreduce/" class="">Vector Sum Reduction</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/manual-vectorization/faster-sumreduce/" class="">Faster Vector Sum Reduction</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/manual-vectorization/sweep/" class="">Vectorizing A Simple Pair Sweep</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/manual-vectorization/cll-avx512/" class="">Vectorizing Cell-based Pair Search</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-82c659c7714fca9486231756ebb8db74" class="toggle"  />
    <label for="section-82c659c7714fca9486231756ebb8db74" class="flex justify-between">
      <a role="button" class="">Useful code snippets</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/useful/fixed-cutoff-direct-pair-search/" class="">Direct pair search</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/useful/fixed-cutoff-cell-lists-pair-search/" class="">Cell list pair search</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/useful/fixed-cutoff-cell-lists-pair-searchhalf-search/" class="">Cell list pair search - reducing search space</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/useful/grid-rows-spatial-hashing/" class="">grid dimension hashing</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/useful/fixed-cutoff-pair-search-noifs/" class="">Cell lists pair search without &#34;if&#34;</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/useful/z-curve-spatial-hashing/" class="">Z-curve hashing</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/caf/" class="">Coarray Fortran Things</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-70035f3795255ae1e304b2577ac7a328" class="toggle" checked />
    <label for="section-70035f3795255ae1e304b2577ac7a328" class="flex justify-between">
      <a role="button" class="">CUDA Programming</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/cuda-wsl/" class="">CUDA &#43; NVHPC on WSL</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/frn-thrust/" class="active">Fixed-Radius Neighbour Search Using Thrust</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-87ae867329107c34e1f6caa377fccc2a" class="toggle"  />
    <label for="section-87ae867329107c34e1f6caa377fccc2a" class="flex justify-between">
      <a href="/worknotes/docs/cfdem/" class="">CFDEM</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cfdem/cavitycfdem/" class="">OpenFOAM cavity case to CFDEM</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cfdem/snappyhexmesh/" class="">Snappy Hex Mesh Basics</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cfdem/liggghts-intel-comp/" class="">Speeding Up LIGGGHTS with Intel Compilers and Compiler Options</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-89270b1739b00fc57bd375e4e320a20e" class="toggle"  />
    <label for="section-89270b1739b00fc57bd375e4e320a20e" class="flex justify-between">
      <a role="button" class="">Raspberry Pis</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/pi/yolov5-orangepi/" class="">Combining the Orange Pi 5 Pro and YOLOv5 for bird detection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/pi/trim-jetsonnano/" class="">Reducing Jetson Nano OS for Server</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/pi/webserver/" class="">Setting Up Public Webserver on Raspberry Pi</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/pi/slurm-cluster/" class="">Setting Up Raspberry Pi Slurm Cluster</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>











  
<ul>
  
  <li>
    <a href="https://github.com/edoyango"  target="_blank" rel="noopener">
        GitHub
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/worknotes/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Fixed-Radius Neighbour Search Using Thrust</strong>

  <label for="toc-control">
    
    <img src="/worknotes/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#fixed-radius-neighbour-search-using-thrust">Fixed-Radius Neighbour Search Using Thrust</a>
      <ul>
        <li><a href="#why-thrust">Why Thrust?</a></li>
        <li><a href="#the-algorithm">The algorithm</a></li>
        <li><a href="#the-details">The details</a>
          <ul>
            <li><a href="#defining-algorithm-constants">Defining Algorithm Constants</a></li>
            <li><a href="#finding-the-grid-extents">Finding the grid extents</a></li>
            <li><a href="#mapping-the-particles-to-the-grid-and-sorting">Mapping the particles to the grid and sorting</a></li>
            <li><a href="#finding-the-cell-end-indices">Finding the cell end indices</a></li>
            <li><a href="#generating-potential-pairs">Generating potential pairs</a></li>
          </ul>
        </li>
        <li><a href="#results">Results</a>
          <ul>
            <li><a href="#timings-on-more-nvidia-gpus">Timings on more NVIDIA GPUs</a></li>
            <li><a href="#timings-with-amd-gpus">Timings with AMD GPUs</a></li>
            <li><a href="#memory-saving-strategies">Memory saving strategies?</a></li>
          </ul>
        </li>
        <li><a href="#conclusions">Conclusions</a></li>
        <li><a href="#full-code">Full code</a>
          <ul>
            <li><a href="#find_pairshpp">find_pairs.hpp</a></li>
            <li><a href="#democpp">demo.cpp</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="fixed-radius-neighbour-search-using-thrust">
  Fixed-Radius Neighbour Search Using Thrust
  <a class="anchor" href="#fixed-radius-neighbour-search-using-thrust">#</a>
</h1>
<p>This page describes how one might implement the pair-finding algorithm described by 
  <a href="https://developer.download.nvidia.com/assets/cuda/files/particles.pdf">Simon Green (2010)</a>.
Many implementations of Simon&rsquo;s work exists, such as the 
  <a href="https://github.com/lxxue/FRNN">FRNN Python package</a>.</p>
<h2 id="why-thrust">
  Why Thrust?
  <a class="anchor" href="#why-thrust">#</a>
</h2>
<p>I would argue that there is a fairly strong incentive to make GPU-accelerated codes portable across different
hardware platforms. At the time of writing, NVIDIA GPUs are becoming more challenging to get a hold of, and are
more expensive relative to their competition (i.e., AMD and Intel GPUs). Consequently, it is becoming harder to justify
writing code exclusively using the CUDA ecosystem.</p>
<p>While Thrust was originally exclusive to NVIDIA platforms, AMD have developed 
  <a href="https://github.com/ROCm/rocThrust">their own implementation</a>
and Intel&rsquo;s OneDPL provides similar functionality with an almost identical API (see 
  <a href="https://www.intel.com/content/www/us/en/developer/articles/technical/migrating-thrust-to-sycl-and-onedpl.html?cid=iosm&amp;source=linkedin&amp;campid=2022_oneapi_some_q1-q4&amp;content=100003621273984&amp;icid=satg-obm-campaign&amp;linkId=100000172866525">their article</a>
describing how to port Thrust applications to OneDPL).</p>
<p>Thrust is also high-level and aims to replicate the STL and includes many optimised algorithms such as sorting and
scanning, which will be leveraged here. This means using Thrust avoids the need of having to self-write these algorithms
(like what the FRNN package does), is comparatively easy to understand for existing C++ developers, and is portable.</p>
<h2 id="the-algorithm">
  The algorithm
  <a class="anchor" href="#the-algorithm">#</a>
</h2>
<p>Simon&rsquo;s article already does a good job of describing how the pair-search algorithm is supposed to work, so I will defer
the high-level description to that paper.</p>
<p>However, Simon&rsquo;s paper stops at creating the uniform grid using sorting, and creating an array indicating the starts of the
cells. Here, I show the steps beyond.</p>
<p>In this algorithm, after the particle-to-grid mapping is created, we determine</p>
<h2 id="the-details">
  The details
  <a class="anchor" href="#the-details">#</a>
</h2>
<p>Here, I&rsquo;m writing the algorithm inside a function, assuming it will be called elsewhere. The function will take in
three <code>thrust::device_vector&lt;F&gt;</code>, where <code>F</code> is a template type. It will also take a singular <code>F</code> value, which represents
the cutoff radius which defines an interacting pair. Importantly, the input device vectors must be passed by reference,
because they will be permuted based on the sorting. The function will return a <code>std::pair</code> of device vectors, where each
device vector represents one of the sides of the output pairs found. A template parameter, <code>I</code> will be used to specify
the integer type of the indices. Thus, the function definition will look like:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;thrust/host_vector.h&gt;</span><span style="color:#8f5902;font-style:italic">                </span><span style="color:#8f5902;font-style:italic">// thrust::host_vector
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;thrust/device_vector.h&gt;</span><span style="color:#8f5902;font-style:italic">              </span><span style="color:#8f5902;font-style:italic">// thrust::device_vector
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;thrust/sort.h&gt;</span><span style="color:#8f5902;font-style:italic">                       </span><span style="color:#8f5902;font-style:italic">// thrust::sort_by_key
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;thrust/gather.h&gt;</span><span style="color:#8f5902;font-style:italic">                     </span><span style="color:#8f5902;font-style:italic">// thrust::gather
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;thrust/iterator/counting_iterator.h&gt;</span><span style="color:#8f5902;font-style:italic"> </span><span style="color:#8f5902;font-style:italic">// thrust::counting_iterator
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;utility&gt;</span><span style="color:#8f5902;font-style:italic">                             </span><span style="color:#8f5902;font-style:italic">// std::pair
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;thrust/remove.h&gt;</span><span style="color:#8f5902;font-style:italic">                     </span><span style="color:#8f5902;font-style:italic">// thrust::remove_if
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;thrust/sequence.h&gt;</span><span style="color:#8f5902;font-style:italic">                    </span><span style="color:#8f5902;font-style:italic">// thrust::sequence
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;nvtx3/nvToolsExt.h&gt;</span><span style="color:#8f5902;font-style:italic">                  </span><span style="color:#8f5902;font-style:italic">// nvtxRangePush, nvtxRangePop
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">typename</span> <span style="color:#000">F</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">typename</span> <span style="color:#000">I</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">I</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">I</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#000">find_pairs</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">z</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">F</span> <span style="color:#000">cutoff</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">nvtxRangePush</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;find_pairs&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// body ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">nvtxRangePop</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>nvtx3/nvToolsExt.h</code> is included so the NVTX ranges can be used for profiling with NSight Systems. Both the whole function smaller
regions will have function calls.</p>
<h3 id="defining-algorithm-constants">
  Defining Algorithm Constants
  <a class="anchor" href="#defining-algorithm-constants">#</a>
</h3>
<p>To mitigate mistakes and make the code easier to read, lets define constants related to the algorithm.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// define constants
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#8f5902;font-style:italic">// cell size is cutoff/cells_per_cutoff
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">constexpr</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">cells_per_cutoff</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// the length of the cube that forms the search space (units: no. of cells)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#000">search_cube_len</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cells_per_cutoff</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// no. of adjacent cells to search
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#000">n_search_adj_cells</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">search_cube_len</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">search_cube_len</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">search_cube_len</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// no. of cells to search i.e. the number of adjacent cell plus the particle&#39;s own cell.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#000">n_search_all_cells</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">n_search_adj_cells</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// inside function body
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// size of each cell
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">F</span> <span style="color:#000">cell_size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cutoff</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">F</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cells_per_cutoff</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>In Simon&rsquo;s paper, each cell in the algorithm is equal to the length of the cutoff distance. Later, we&rsquo;ll explore this number. The
remaining constants are derivative numbers related to this ratio.</p>
<h3 id="finding-the-grid-extents">
  Finding the grid extents
  <a class="anchor" href="#finding-the-grid-extents">#</a>
</h3>
<p>The first step is to find the extents of the grid that encapsulates the particle cloud. Thrust offers the
<code>minmax_element</code> function in the <code>thrust/extrema.h</code> header file, which can be used here:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>    <span style="color:#000">nvtxRangePush</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;grid extents&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// declare the min-max extent arrays
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">F</span> <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// find the extents
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">auto</span> <span style="color:#000">res</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">minmax_element</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">first</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">second</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">res</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">minmax_element</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">first</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">second</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">res</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">minmax_element</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">z</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">first</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">second</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// extend the grid to ensure there are buffer cells
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">-=</span> <span style="color:#000">F</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2.</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">F</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2.</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Important to note here that the return type of <code>thrust::minmax_element</code> is a pair of <code>device_ptr</code> which must be
dereferenced to be stored in the <code>mingrid</code>, <code>maxgrid</code> arrays. <code>minmax_element</code> is called three times - one for each
coordinate. Finally, the minima and maxima of the grid are extended so that when adjacent cells of particles are
searched later, they stay within the bounds.</p>
<p>Before continuing to the next step, we can calculate the number of cells in each direction:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cell_size</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cell_size</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cell_size</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">nvtxRangePop</span><span style="color:#000;font-weight:bold">();</span>
</span></span></code></pre></div><p>Which rounds up the number of grid cells. Optionally, you can update the maxima of the grid, but isn&rsquo;t really necessary
as the maxima aren&rsquo;t used from herein. The &ldquo;grid extents&rdquo; NVTX region is also stopped.</p>
<h3 id="mapping-the-particles-to-the-grid-and-sorting">
  Mapping the particles to the grid and sorting
  <a class="anchor" href="#mapping-the-particles-to-the-grid-and-sorting">#</a>
</h3>
<p>This is the step that Simon&rsquo;s paper illustrates. First we must determine the grid cell indices that each cell belongs
to. As per Simon&rsquo;s paper, we&rsquo;re using a scalar &ldquo;hash&rdquo; to map particles to grid cells. This 1D hash is beneficial for two
reasons:</p>
<ol>
<li>the algorithm itself is sped up as less data is transferred when retrieving the grid indices</li>
<li>spatial locality is improved.</li>
</ol>
<p>First assigning particles to grid cells:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>    <span style="color:#000">nvtxRangePush</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;map points to grid&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// declare array to store particles&#39; grid indices
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// this makes the device vector&#39;s data accessible in the lambda
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_ptr</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">d_gidx</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">()};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// map particles to grid
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">transform</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">make_zip_iterator</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">make_tuple</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">())),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">make_zip_iterator</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">make_tuple</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">())),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">__device__</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">detail</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">tuple_of_iterator_references</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&amp;&gt;</span> <span style="color:#000">in</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">idxx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">get</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cell_size</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#8f5902;font-style:italic">// x grid index
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                      <span style="color:#000">idxy</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">get</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cell_size</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#8f5902;font-style:italic">// y grid index
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                      <span style="color:#000">idxz</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">get</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cell_size</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// z grid index
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">idxy</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">idxx</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">idxz</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// convert to 1D grid index and return
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000">nvtxRangePop</span><span style="color:#000;font-weight:bold">();</span>
</span></span></code></pre></div><p>There&rsquo;s a lot going on here so let&rsquo;s break it down:</p>
<ul>
<li><code>thrust::transform</code>
<ul>
<li>is used to transform the values of an input iterator, and place them in an output iterator (in this case, <code>gidx</code>).</li>
</ul>
</li>
<li><code>thrust::make_zip_iterator(thrust::make_tuple(...))</code>
<ul>
<li>this &ldquo;packs&rdquo; the forward iterators as provided by <code>x/y/z.begin()</code>, so that each <code>thrust::transform</code> iteration has
access to the corresponding x, y, and z values.</li>
</ul>
</li>
<li><code>gidx.begin()</code>
<ul>
<li>specifies that the output is to be placed in <code>gidx</code>.</li>
</ul>
</li>
<li><code>[=] __device__ (...)</code>
<ul>
<li>is a lambda (can be used since compute capability 7.0). <code>[=]</code> specifies that external values should be captured
by value. Capturing external variables by reference is unavailable in a CUDA lambda. The <code>__device__</code> attribute
specifes that the generated lambda instructions is for the device aka GPU.</li>
<li>the lambda accepts a <code>thrust::detail::tuple_of_iterator_references</code>, which is a tuple of each of the x, y, z
values. These values, are retrieved with the <code>thrust::get&lt;i&gt;</code> function, where <code>i</code> is an index.</li>
<li><code>static_cast&lt;I&gt;((thrust::get&lt;i&gt;(in) - mingrid[i])/cutoff)</code> is obtaining the grid index in the <code>i</code>th direction.
The &ldquo;hashing&rdquo; function ensures that that the grid is &ldquo;column major&rdquo; i.e., the third index is consecutive in memory.</li>
</ul>
</li>
</ul>
<p>Now that each particle has been assigned a grid cell index, we can sort the grid cells, and obtain a mapping of old
array indices to new ones.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>    <span style="color:#000">nvtxRangePush</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;sort particles&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// sort particles based on grid index. Performed in a block to manage scratch space.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// initialize permute
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">sequence</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">());</span> <span style="color:#8f5902;font-style:italic">// e.g., 0 1 2 3 4
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// sort gidx
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">sort_by_key</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">/* e.g. before gidx = 1 9 2 8 3, permute = 0 1 2 3 4
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                after  gidx = 1 2 3 8 9, permute = 0 2 4 3 1 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// gather old positions into new ones
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">gather</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">/* e.g. before x = 0.1 0.5 0.1 0.5 0.3, tmp = ?   ?   ?   ?   ?
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                after  x = &#34;                 &#34;, tmp = 0.1 0.1 0.3 0.5 0.5 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">copy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// e.g.        x = 0.1 0.1 0.3 0.5 0.5
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// repeat for y, z
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">gather</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">copy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">gather</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">copy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">nvtxRangePop</span><span style="color:#000;font-weight:bold">();</span>
</span></span></code></pre></div><p>Hopefully the examples in the comments are enough to illustrate what&rsquo;s going on. But, at a high-level, the <code>permute</code>
vector is initialized with numbers 0 to the length of permute (which is the same as gidx). Then, <code>thrust::sort_by_key</code>
sorts the <code>gidx</code> vector, as well as updating <code>permute</code> such that the <code>i</code>th element of <code>permute</code> corresponds to the old
position of the <code>i</code>th element in the now sorted <code>gidx</code> vector. <code>thrust::gather</code> is then used to permute the old <code>x/y/z</code>
vectors into their new positions in a temporary vector, which is then copied back to the original vector using
<code>thrust::copy</code>. Unfortunately, there&rsquo;s no way that I know of to do this in a single function.</p>
<h3 id="finding-the-cell-end-indices">
  Finding the cell end indices
  <a class="anchor" href="#finding-the-cell-end-indices">#</a>
</h3>
<p>In Simon&rsquo;s paper, the start of each cell in <code>gidx</code> is obtained. But here, the end of each cell is obtained. The ends
are recorded instead of the starts as the algorithms are a little more convenient to write.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>    <span style="color:#000">nvtxRangePush</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;find cell ends&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// initialize cell_ends vector and initialize to 0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// create device_ptr needed for lambda
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_ptr</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">d_cell_ends</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">()};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">for_each</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">counting_iterator</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">counting_iterator</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">()),</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">__device__</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">this_cell</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_gidx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">prev_cell</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_gidx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">this_cell</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">prev_cell</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">d_cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">prev_cell</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// e.g. gidx = 1 2 3 8 9, cell_ends = 0 1 2 3 0 0 0 0 0 4 5 0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">inclusive_scan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">maximum</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// e.g. cell_ends = 0 1 2 3 3 3 3 3 3 4 5 5
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">nvtxRangePop</span><span style="color:#000;font-weight:bold">();</span>
</span></span></code></pre></div><p>After the initialization of the <code>cell_ends</code> vector (which is hopefully self-explanatory), two device pointers are
generated, pointing to the underlying data of <code>cell_ends</code> and <code>gidx</code>.</p>
<p>The <code>thrust::for_each</code> function is effectively a <code>for</code> loop and serves a similar purpose to <code>std::for_each</code>.
<code>thrust::counting_iterator</code> is used to specify that range of the loop. A lambda is used to define the work done in each
iteration of the loop, which is to first check whether the <code>i</code>th entry of <code>gidx</code> is different from the previous entry.
If it is different, that means the <code>i</code>th element is recorded as the end of the cell <code>gidx[i-1]</code>, so <code>cell_ends</code> is
updated. Note:</p>
<ul>
<li>lambdas cannot use the <code>device_vector</code> accessor operator (<code>[]</code>), hence the need to create a <code>device_ptr</code>.</li>
<li>after the <code>for_each</code>, <code>cell_ends</code> possesses zeroes in cell indices which aren&rsquo;t in <code>gidx</code>.</li>
</ul>
<p><code>cell_ends</code> can be used even with zeroes, but it&rsquo;s more convenient to ensure that they are filled with something
meaningful. Here, the intention is to use <code>cell_ends</code> to specify the range of particle indices that belong to a cell.
For example, if <code>cell_ends = 0 1 2 3 0 0 0 0 0 4 5 0</code>, then the start of cell 3 is found at <code>cell_ends[2]</code>, and the end
is found at <code>cell_ends[3]</code> (open-interval). If the zeroes remain, then for cell 8, the the start may be specified as
<code>cell_ends[7] = 0</code>, and the end is <code>cell_ends[8] = 4</code>, which is not correct. If the zeroes are &ldquo;filled&rdquo; with a
sensible value, then we can use <code>cell_ends[i-1]</code> as the first particle index for cell <code>i</code>.</p>
<p>Hence, <code>thrust::inclusive_scan</code>, with a <code>thrust:maximum</code> binary functor fills in the zeroes with the largest value
up to that index. In the previous example, you should be able to see that <code>cell_ends[7] = 3</code>, providing the correct
starting particle index to use for cell 8.</p>
<h3 id="generating-potential-pairs">
  Generating potential pairs
  <a class="anchor" href="#generating-potential-pairs">#</a>
</h3>
<p>In my version of the finding pair algorithm, I avoid using atomics as they can degrade performance significantly in
cases where there is high-contention (i.e., many threads are trying to update the same variable). In addition, AMD
GPUs don&rsquo;t do atomic operations that well. To avoid atomics, I generate potential pairs first, and then compacting these
pairs into realised pairs.</p>
<p>When generating potential pairs, it&rsquo;s important to understand that for each particle, only half the neighbouring cells
need to be searched. This is because finding pairs is symmetric i.e., if one particle is found to be paired with
another, I don&rsquo;t need to do the reverse check. Consequently, for each particle, only the &ldquo;lowest&rdquo; 14 cells are searched
for neighbours (one of those cells being its own). See the figure below for an illustration and note that cell indices
are relative to the particle of interest&rsquo;s cell.</p>
<p>
  <img src="/worknotes/imgs/grid-search-space.png" alt="Diagram showing the cells searched for neighbours" /></p>
<p>Given that each particle will check a cell for neighbours, we must first figure out how many checks will be done.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>    <span style="color:#000">nvtxRangePush</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;populate nchecks&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// initialize number of checks
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">size_t</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">n_search_all_cells</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_ptr</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">size_t</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">d_nchecks</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">()};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// populate nchecks
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">for_each</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">counting_iterator</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">counting_iterator</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">()),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">__device__</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">loc</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">n_search_all_cells</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">my_idx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_gidx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">start_idx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">my_idx</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">cells_per_cutoff</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">cells_per_cutoff</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">cells_per_cutoff</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">n_search_all_cells</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// which cell am i comparing to?
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">idxz</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">search_cube_len</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                          <span style="color:#000">rem</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000">search_cube_len</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>                          <span style="color:#000">idxy</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rem</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">search_cube_len</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>                          <span style="color:#000">idxx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rem</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000">search_cube_len</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">neighbour_idx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">start_idx</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">idxx</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">idxy</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">idxz</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// get the starting particle index
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">start_pidx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">neighbour_idx</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">end_pidx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">j</span><span style="color:#ce5c00;font-weight:bold">==</span><span style="color:#000">n_search_adj_cells</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#f57900">i</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#000">d_cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">neighbour_idx</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">d_nchecks</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">loc</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">size_t</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">end_pidx</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">start_pidx</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>After <code>nchecks</code> is initialized, a <code>thrust::for_each</code> call is used, using the <code>thrust::counting_iterator</code> to specify the
iteration range. As many threads as there are particles is launched, where each thread is responsible for generating
the number checks to be done for the relevant neighbouring cells.</p>
<p>Now, we can get the total number of checks to be performed:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">size_t</span> <span style="color:#000">last_ncheck_prescan</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">back</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">exclusive_scan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">size_t</span> <span style="color:#000">nchecks_total</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">last_ncheck_prescan</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">back</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">nvtxRangePop</span><span style="color:#000;font-weight:bold">();</span>
</span></span></code></pre></div><p>The <code>thrust::exclusive_scan</code> turns the <code>nchecks</code> vector into a vector that specifies the starting index within the
potential pair list that correspond to a particle <code>i</code> and one of its neighbouring cells. With that information, the
actual generation of potential pairs can be performed.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>    <span style="color:#000">nvtxRangePush</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;generate potential pairs&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// initialize potential pair list
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">potential_pairs_i</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nchecks_total</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">potential_pairs_j</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nchecks_total</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_ptr</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">d_potential_pairs_i</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">potential_pairs_i</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">()),</span> <span style="color:#000">d_potential_pairs_j</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">potential_pairs_j</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// allocate vector to flag which potential pair is an actual pair
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">is_neighbour</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nchecks_total</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_ptr</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">d_is_neighbour</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">is_neighbour</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">()};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// search potential pairs and flag actual pairs
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">for_each</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">counting_iterator</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">counting_iterator</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">()),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">__device__</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ii</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ii</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">n_search_all_cells</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">neighbour</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ii</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">n_search_all_cells</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">my_idx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_gidx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> 
</span></span><span style="display:flex;"><span>                      <span style="color:#000">start_idxz</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">neighbour</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">search_cube_len</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>                      <span style="color:#000">rem</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">neighbour</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">search_cube_len</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>                      <span style="color:#000">start_idxx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rem</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000">search_cube_len</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>                      <span style="color:#000">start_idxy</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rem</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">search_cube_len</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">neighbour_idx</span> <span style="color:#ce5c00;font-weight:bold">=</span> 
</span></span><span style="display:flex;"><span>                      <span style="color:#000">my_idx</span> <span style="color:#ce5c00;font-weight:bold">+</span> 
</span></span><span style="display:flex;"><span>                      <span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start_idxx</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">cells_per_cutoff</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> 
</span></span><span style="display:flex;"><span>                      <span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start_idxy</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">cells_per_cutoff</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> 
</span></span><span style="display:flex;"><span>                      <span style="color:#000;font-weight:bold">(</span><span style="color:#000">start_idxz</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">cells_per_cutoff</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">start_idx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">neighbour_idx</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> 
</span></span><span style="display:flex;"><span>                      <span style="color:#000">end_idx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">neighbour</span><span style="color:#ce5c00;font-weight:bold">==</span><span style="color:#000">n_search_adj_cells</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#f57900">i</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#000">d_cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">neighbour_idx</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">size_t</span> <span style="color:#000">loc</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_nchecks</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">ii</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">F</span> <span style="color:#000">xi</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">yi</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">zi</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">start_idx</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">end_idx</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">F</span> <span style="color:#000">dx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">d_x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">dy</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">yi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">d_y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">dz</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">zi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">d_z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">d_is_neighbour</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">loc</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dx</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dx</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">dy</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dy</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">dz</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dz</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">cutoff</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// faster to always save pairs - even if not an actual pair.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#000">d_potential_pairs_i</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">loc</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">d_potential_pairs_j</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">loc</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">j</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">loc</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">nvtxRangePop</span><span style="color:#000;font-weight:bold">();</span>
</span></span></code></pre></div><p>This step is quite complex, but hopefully the comments are sufficient. The potential pair list can be compacted
with a <code>remove_if</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>    <span style="color:#000">nvtxRangePush</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;compact potential pairs&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">potential_pairs_i</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">erase</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">remove_if</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">potential_pairs_i</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#000">potential_pairs_i</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#000">is_neighbour</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">logical_not</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#000">potential_pairs_i</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">potential_pairs_j</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">erase</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">remove_if</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">potential_pairs_j</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#000">potential_pairs_j</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#000">is_neighbour</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">logical_not</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#000">potential_pairs_j</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">nvtxRangePop</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// return indices as a pair of vectors
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#000">pairs_out</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">move</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">potential_pairs_i</span><span style="color:#000;font-weight:bold">),</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">move</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">potential_pairs_j</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// end of the range started at the start of the function
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">nvtxRangePop</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">pairs_out</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><h2 id="results">
  Results
  <a class="anchor" href="#results">#</a>
</h2>
<p>To test the performance we use the following test case:</p>
<ul>
<li>1,000,000 particles</li>
<li>positions generated randomly such that each coordinate is between 0 and 1</li>
<li>positions stored as double precision (relevant in simulation codes)</li>
<li>positions already sent to GPU.</li>
<li>cutoff radius is 0.03 (3 times the average particle spacing).</li>
<li>run on an A100 PCIE</li>
<li>compiled with <code>nvcc -O3 --use_fast_math --extended-lambda --compiler-options &quot;-march=native -mtune=native&quot;</code> using
CUDA 12.2 with <code>gcc</code> 11.2.0 used as the base.
<ul>
<li>Latest CUDA at time of writing is 13.0 and latest gcc is 15.2. However, the CUDA drivers on the A100s I have
access to have been kept back to 12.2 for some reason.</li>
</ul>
</li>
</ul>
<p>With 5 different randomly generated positions, time taken to generate pairs for these positions is approximately 70ms.
Using the CPU on the node of the GPU (I think it&rsquo;s Intel Xeon Gold 5320), time to find the same pairs is around 2.27s -
roughly 32.4x faster. My laptop CPU (AMD 8845hs) takes about 1.30s which means <strong>the GPU speedup is more like a 18.6x</strong>.</p>
<p>A fairly significant drawback of the algorithm here is that it consumes a lot of memory. On average, the potential pair
list will consume 81/(4pi) ~ 6.5x more memory than the actual pair list. this is due to the search space being a cube
of length 3r, and the actual &ldquo;pair&rdquo; space being a sphere of radius r. Indeed, for this test case, the potential pair
list ends up being around 340e6 elements, and the actual pair list is about 55e6.</p>
<p>If we halve the cell size used in this algorithm, the search space decreases by a multiple of <code>(5/6)^3 ~= 0.58</code>. This
is because the search region decreases from <code>6*cutoff</code> to <code>5*cutoff</code>. On the other hand, the grid size is increased by
8x. To test this change in the code, <code>cells_per_cutoff = 1</code> can be changed to <code>cells_per_cutoff = 2</code>.</p>
<p>After this change, both the CPU and GPU times are improved. The GPU time goes down to approx. 38.5ms and the best CPU
time on my laptop goes down to 1.08s, which means <strong>the GPU is about 28x faster after halving the cell size to be half
the cutoff radius</strong>.</p>
<p>Times when using cell size of 1 cutoff distance:</p>
<table>
  <thead>
      <tr>
          <th>Test No.</th>
          <th>AMD 8845hs CPU (1 core)</th>
          <th>Intel Xeon Gold 5320 (?) CPU (1 core)</th>
          <th>NVIDIA A100 40GB PCIE</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>0</td>
          <td>1,302,816</td>
          <td>2,270,481</td>
          <td>66,773</td>
      </tr>
      <tr>
          <td>1</td>
          <td>1,277,524</td>
          <td>2,275,148</td>
          <td>68,877</td>
      </tr>
      <tr>
          <td>2</td>
          <td>1,293,674</td>
          <td>2,271,051</td>
          <td>72,801</td>
      </tr>
      <tr>
          <td>3</td>
          <td>1,303,622</td>
          <td>2,262,606</td>
          <td>68,817</td>
      </tr>
      <tr>
          <td>4</td>
          <td>1,301,695</td>
          <td>2,269,497</td>
          <td>72,792</td>
      </tr>
  </tbody>
</table>
<p>Times when using cell size of 2 cutoff distances:</p>
<table>
  <thead>
      <tr>
          <th>Test No.</th>
          <th>AMD 8845hs CPU (1 core)</th>
          <th>Intel Xeon Gold 5320 (?) CPU (1 core)</th>
          <th>NVIDIA A100 40GB PCIE</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>0</td>
          <td>1,095,293</td>
          <td>1,917,234</td>
          <td>39,036</td>
      </tr>
      <tr>
          <td>1</td>
          <td>1,060,066</td>
          <td>1,916,948</td>
          <td>38,466</td>
      </tr>
      <tr>
          <td>2</td>
          <td>1,080,604</td>
          <td>1,917,818</td>
          <td>38,535</td>
      </tr>
      <tr>
          <td>3</td>
          <td>1,073,272</td>
          <td>1,914,739</td>
          <td>38,492</td>
      </tr>
      <tr>
          <td>4</td>
          <td>1,103,100</td>
          <td>1,913,439</td>
          <td>38,247</td>
      </tr>
  </tbody>
</table>
<p>All times are in microseconds.</p>
<p>The number of potential pairs decreases from around 3.4e8 to 2.0e8, which is quite close to the estimated reduction.
The number of grid cells goes up from 4.7e4 to 3.6e5, but the increase in grid size is far outweighed by the savings
in number of potential pairs. Increasing <code>cells_per_cutoff</code> to 3 gives a segmentation fault - something to fix later&hellip;</p>
<h3 id="timings-on-more-nvidia-gpus">
  Timings on more NVIDIA GPUs
  <a class="anchor" href="#timings-on-more-nvidia-gpus">#</a>
</h3>
<p>I have access to a couple other NVIDIA GPU models: the 4060 on my laptop, and the V100 SXM2 available on Australia&rsquo;s
national HPC. These are tested using the CUDA compatible with their driver versions (CUDA 13.0 for the laptop GPU and
12.9 for the V100).</p>
<p><code>cells_per_cutoff = 1</code> (times in microseconds):</p>
<table>
  <thead>
      <tr>
          <th>Test No.</th>
          <th>RTX 4060 Laptop</th>
          <th>V100 SXM2</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>0</td>
          <td>129,026</td>
          <td>273,390</td>
      </tr>
      <tr>
          <td>1</td>
          <td>118,909</td>
          <td>244,307</td>
      </tr>
      <tr>
          <td>2</td>
          <td>118,061</td>
          <td>242,003</td>
      </tr>
      <tr>
          <td>3</td>
          <td>115,862</td>
          <td>242,124</td>
      </tr>
      <tr>
          <td>4</td>
          <td>120,650</td>
          <td>241,957</td>
      </tr>
  </tbody>
</table>
<p><code>cells_per_cutoff = 2</code> (times in microseconds):</p>
<table>
  <thead>
      <tr>
          <th>Test No.</th>
          <th>RTX 4060 Laptop</th>
          <th>V100 SXM2</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>0</td>
          <td>97,391</td>
          <td>68,541</td>
      </tr>
      <tr>
          <td>1</td>
          <td>80,113</td>
          <td>52,337</td>
      </tr>
      <tr>
          <td>2</td>
          <td>79,696</td>
          <td>52,359</td>
      </tr>
      <tr>
          <td>3</td>
          <td>80,592</td>
          <td>51,514</td>
      </tr>
      <tr>
          <td>4</td>
          <td>80,473</td>
          <td>54,169</td>
      </tr>
  </tbody>
</table>
<p>The laptop GPU performance was quite good - achieving roughly half the performance at 14% of the TDP of the A100 (35W
vs 250W). I was a bit worried about the V100 when <code>cells_per_cutoff = 1</code>, but its performance improved dramatically
for <code>cells_per_cutoff = 2</code>.</p>
<h3 id="timings-with-amd-gpus">
  Timings with AMD GPUs
  <a class="anchor" href="#timings-with-amd-gpus">#</a>
</h3>
<p>Getting the code to work with GPUs was fairly trivial. I only needed to make sure I had a working ROCm version with
<code>hipcc</code> and <code>rocthrust</code> installed. These came with the <code>rocm</code> debian package. The compilation command used was</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>hipcc test.cu
</span></span></code></pre></div><p>Which compiles with O3 by default. The only code change I needed was to swap out <code>cudaDeviceSynchronize</code> with
<code>hipDeviceSynchronize</code> and remove the NVTX code. ROCm used here are 6.4.1 for the MI250X tests and 6.4.4 for the
780m tests.</p>
<p><code>cells_per_cutoff = 1</code> (times in microseconds):</p>
<table>
  <thead>
      <tr>
          <th>Test No.</th>
          <th>AMD MI250X (1 GCD)</th>
          <th>AMD 780m</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>0</td>
          <td>147,227</td>
          <td>515,262</td>
      </tr>
      <tr>
          <td>1</td>
          <td>134,363</td>
          <td>498,018</td>
      </tr>
      <tr>
          <td>2</td>
          <td>134,714</td>
          <td>501,888</td>
      </tr>
      <tr>
          <td>3</td>
          <td>133,510</td>
          <td>507,251</td>
      </tr>
      <tr>
          <td>4</td>
          <td>134,214</td>
          <td>543,599</td>
      </tr>
  </tbody>
</table>
<p><code>cells_per_cutoff = 2</code> (times in microseconds):</p>
<table>
  <thead>
      <tr>
          <th>Test No.</th>
          <th>AMD MI250X (1 GCD)</th>
          <th>AMD 780m</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>0</td>
          <td>31,982</td>
          <td>370,167</td>
      </tr>
      <tr>
          <td>1</td>
          <td>26,035</td>
          <td>348,793</td>
      </tr>
      <tr>
          <td>2</td>
          <td>25,956</td>
          <td>348,691</td>
      </tr>
      <tr>
          <td>3</td>
          <td>26,083</td>
          <td>353,354</td>
      </tr>
      <tr>
          <td>4</td>
          <td>25,915</td>
          <td>360,320</td>
      </tr>
  </tbody>
</table>
<p>The MI250X impressed me with its performance at <code>cells_per_cutoff = 2</code> - achieving the fastest times of all the GPUs
tested here and achieving an approx <code>1080/26 ~= 41.5x</code> speedup over the fastest CPU single-core time.</p>
<p>I wasn&rsquo;t expecting good performance from my laptop&rsquo;s integrated 780m graphics, but it was useful to see how portable
the code really was.</p>
<h3 id="memory-saving-strategies">
  Memory saving strategies?
  <a class="anchor" href="#memory-saving-strategies">#</a>
</h3>
<h2 id="conclusions">
  Conclusions
  <a class="anchor" href="#conclusions">#</a>
</h2>
<p>Relative to single-core CPU code, the thrust code running on the GPU was seen to be between 28-40.5x faster - depending
on the hardware used to do the comparison. For the condition where number of neighbours per point/particle are fixed,
the time complexity is O(n). This scenario is representative of particle simulations like Discrete Element Method and
Smoothed Particle Hydrodynamics where neighbours are kept fixed as more particles are introduced. A useful property of
the algorithm shown here is that the order of pairs found is deterministic and reproducible, but with a significant
memory overhead.</p>
<p>As a whole, I find thrust not too difficult to use, as a fairly unsophisticated C++ programmer. It abstracts a lot of
the GPU programming, and gives access to very useful and optimised algorithms, while also being fairly platform
portable. I only have two main gripes with it. The first is that making the low-level features unavailable makes it a
little difficult to get the best performance for complex kernels, but I believe that to be intentional and part of the
design. The second issue is the lack of examples. It feels like you have to be a fairly knowledgable programmer to parse
the documentation - although ChatGPT makes it a lot easier.</p>
<p>I&rsquo;m tempted to compare Thrust with Kokkos, which also aims to provide a performance portable programming framework.
Kokkos is much more beginner friendly, with a long spiel about the programming model, good quality examples, and lots of
public training material. It also gives gives access to low-level features such as shared memory and block through
abstractions such as scratch space and teams. However, while most of their key algorithms perform really well, others
like <code>Kokkos::parallel_scan</code> and <code>Kokkos::sort</code> resort to thrust under the hood (they had originally written their own
versions of these algorithms, but they performed 
  <a href="https://github.com/kokkos/kokkos/issues/6838">quite poorly</a>).</p>
<h2 id="full-code">
  Full code
  <a class="anchor" href="#full-code">#</a>
</h2>
<h3 id="find_pairshpp">
  find_pairs.hpp
  <a class="anchor" href="#find_pairshpp">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;thrust/host_vector.h&gt;</span><span style="color:#8f5902;font-style:italic">                </span><span style="color:#8f5902;font-style:italic">// thrust::host_vector
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;thrust/device_vector.h&gt;</span><span style="color:#8f5902;font-style:italic">              </span><span style="color:#8f5902;font-style:italic">// thrust::device_vector
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;thrust/sort.h&gt;</span><span style="color:#8f5902;font-style:italic">                       </span><span style="color:#8f5902;font-style:italic">// thrust::sort_by_key
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;thrust/gather.h&gt;</span><span style="color:#8f5902;font-style:italic">                     </span><span style="color:#8f5902;font-style:italic">// thrust::gather
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;thrust/iterator/counting_iterator.h&gt;</span><span style="color:#8f5902;font-style:italic"> </span><span style="color:#8f5902;font-style:italic">// thrust::counting_iterator
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;utility&gt;</span><span style="color:#8f5902;font-style:italic">                             </span><span style="color:#8f5902;font-style:italic">// std::pair
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;thrust/remove.h&gt;</span><span style="color:#8f5902;font-style:italic">                     </span><span style="color:#8f5902;font-style:italic">// thrust::remove_if
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;thrust/sequence.h&gt;</span><span style="color:#8f5902;font-style:italic">                    </span><span style="color:#8f5902;font-style:italic">// thrust::sequence
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;nvtx3/nvToolsExt.h&gt;</span><span style="color:#8f5902;font-style:italic">                  </span><span style="color:#8f5902;font-style:italic">// nvtxRangePush, nvtxRangePop
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// define constants
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#8f5902;font-style:italic">// cell size is cutoff/cells_per_cutoff
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">constexpr</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">cells_per_cutoff</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// the length of the cube that forms the search space (units: no. of cells)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#000">search_cube_len</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cells_per_cutoff</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// no. of adjacent cells to search
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#000">n_search_adj_cells</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">search_cube_len</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">search_cube_len</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">search_cube_len</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// no. of cells to search i.e. the number of adjacent cell plus the particle&#39;s own cell.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#000">n_search_all_cells</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">n_search_adj_cells</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// thrust version
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">typename</span> <span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#000">find_pairs_demo</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">z</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">F</span> <span style="color:#000">cutoff</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">nvtxRangePush</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;find_pairs&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">nvtxRangePush</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;setup&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// define constant size of each cell
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">F</span> <span style="color:#000">cell_size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cutoff</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">F</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cells_per_cutoff</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_ptr</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">d_x</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">()},</span> <span style="color:#000">d_y</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">()},</span> <span style="color:#000">d_z</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">z</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">()};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">nvtxRangePop</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">nvtxRangePush</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;grid&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// find min-max extents
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">F</span> <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">auto</span> <span style="color:#000">res</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">minmax_element</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">first</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">second</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">res</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">minmax_element</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">first</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">second</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">res</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">minmax_element</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">z</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">first</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">second</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">-=</span> <span style="color:#000">F</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2.</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">F</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2.</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cell_size</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cell_size</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cell_size</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">nvtxRangePop</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000">nvtxRangePush</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;map points to grid&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// declare array to store particles&#39; grid indices
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// this makes the device vector&#39;s data accessible in the lambda
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_ptr</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">d_gidx</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">()};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// map particles to grid
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">transform</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">make_zip_iterator</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">make_tuple</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">())),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">make_zip_iterator</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">make_tuple</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">())),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">__device__</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">detail</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">tuple_of_iterator_references</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&amp;&gt;</span> <span style="color:#000">in</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">idxx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">get</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cell_size</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#8f5902;font-style:italic">// x grid index
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                      <span style="color:#000">idxy</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">get</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cell_size</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#8f5902;font-style:italic">// y grid index
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                      <span style="color:#000">idxz</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">get</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cell_size</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#8f5902;font-style:italic">// z grid index
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">idxy</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">idxx</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">idxz</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// convert to 1D grid index and return
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000">nvtxRangePop</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">nvtxRangePush</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;sort particles&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// sort particles based on grid index. Performed in a block to manage scratch space.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// initialize permute
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">sequence</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">());</span> <span style="color:#8f5902;font-style:italic">// e.g., 0 1 2 3 4
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// sort gidx
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">sort_by_key</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">/* e.g. before gidx = 1 9 2 8 3, permute = 0 1 2 3 4
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                after  gidx = 1 2 3 8 9, permute = 0 2 4 3 1 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// gather old positions into new ones
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">gather</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">/* e.g. before x = 0.1 0.5 0.1 0.5 0.3, tmp = ?   ?   ?   ?   ?
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                after  x = &#34;                 &#34;, tmp = 0.1 0.1 0.3 0.5 0.5 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">copy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// e.g.        x = 0.1 0.1 0.3 0.5 0.5
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// repeat for y, z
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">gather</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">copy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">gather</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">copy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">nvtxRangePop</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000">nvtxRangePush</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;find cell ends&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// initialize cell_ends vector and initialize to 0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// create device_ptr needed for lambda
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_ptr</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">d_cell_ends</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">()};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">for_each</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">counting_iterator</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">counting_iterator</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">()),</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">__device__</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">this_cell</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_gidx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">prev_cell</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_gidx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">this_cell</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">prev_cell</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">d_cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">prev_cell</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// e.g. gidx = 1 2 3 8 9, cell_ends = 0 1 2 3 0 0 0 0 0 4 5 0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">inclusive_scan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">maximum</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// e.g. cell_ends = 0 1 2 3 3 3 3 3 3 4 5 5
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">nvtxRangePop</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000">nvtxRangePush</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;populate nchecks&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// initialize number of checks
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">size_t</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">n_search_all_cells</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_ptr</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">size_t</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">d_nchecks</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">()};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// populate nchecks
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">for_each</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">counting_iterator</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">counting_iterator</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">()),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">__device__</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">loc</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">n_search_all_cells</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">my_idx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_gidx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">start_idx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">my_idx</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">cells_per_cutoff</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">cells_per_cutoff</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">cells_per_cutoff</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">n_search_all_cells</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// which cell am i comparing to?
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">idxz</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">search_cube_len</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                          <span style="color:#000">rem</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000">search_cube_len</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>                          <span style="color:#000">idxy</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rem</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">search_cube_len</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>                          <span style="color:#000">idxx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rem</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000">search_cube_len</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">neighbour_idx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">start_idx</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">idxx</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">idxy</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">idxz</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// get the starting particle index
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">start_pidx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">neighbour_idx</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">end_pidx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">j</span><span style="color:#ce5c00;font-weight:bold">==</span><span style="color:#000">n_search_adj_cells</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#f57900">i</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#000">d_cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">neighbour_idx</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">d_nchecks</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">loc</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">size_t</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">end_pidx</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">start_pidx</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">size_t</span> <span style="color:#000">last_ncheck_prescan</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">back</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">exclusive_scan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">size_t</span> <span style="color:#000">nchecks_total</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">last_ncheck_prescan</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">back</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">nvtxRangePop</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#000">nvtxRangePush</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;generate potential pairs&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// initialize potential pair list
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">potential_pairs_i</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nchecks_total</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">potential_pairs_j</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nchecks_total</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_ptr</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">d_potential_pairs_i</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">potential_pairs_i</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">()),</span> <span style="color:#000">d_potential_pairs_j</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">potential_pairs_j</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// allocate vector to flag which potential pair is an actual pair
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">is_neighbour</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nchecks_total</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_ptr</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">d_is_neighbour</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">is_neighbour</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">()};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// search potential pairs and flag actual pairs
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">for_each</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">counting_iterator</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">counting_iterator</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">()),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">__device__</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ii</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ii</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">n_search_all_cells</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">neighbour</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ii</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">n_search_all_cells</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">my_idx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_gidx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> 
</span></span><span style="display:flex;"><span>                      <span style="color:#000">start_idxz</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">neighbour</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">search_cube_len</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>                      <span style="color:#000">rem</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">neighbour</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">search_cube_len</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>                      <span style="color:#000">start_idxx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rem</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000">search_cube_len</span><span style="color:#000;font-weight:bold">,</span> 
</span></span><span style="display:flex;"><span>                      <span style="color:#000">start_idxy</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rem</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">search_cube_len</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">neighbour_idx</span> <span style="color:#ce5c00;font-weight:bold">=</span> 
</span></span><span style="display:flex;"><span>                      <span style="color:#000">my_idx</span> <span style="color:#ce5c00;font-weight:bold">+</span> 
</span></span><span style="display:flex;"><span>                      <span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start_idxx</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">cells_per_cutoff</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> 
</span></span><span style="display:flex;"><span>                      <span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start_idxy</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">cells_per_cutoff</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> 
</span></span><span style="display:flex;"><span>                      <span style="color:#000;font-weight:bold">(</span><span style="color:#000">start_idxz</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">cells_per_cutoff</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">start_idx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">neighbour_idx</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> 
</span></span><span style="display:flex;"><span>                      <span style="color:#000">end_idx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">neighbour</span><span style="color:#ce5c00;font-weight:bold">==</span><span style="color:#000">n_search_adj_cells</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#f57900">i</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#000">d_cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">neighbour_idx</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">size_t</span> <span style="color:#000">loc</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_nchecks</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">ii</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">F</span> <span style="color:#000">xi</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">yi</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">zi</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">start_idx</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">end_idx</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">F</span> <span style="color:#000">dx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">d_x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">dy</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">yi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">d_y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">dz</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">zi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">d_z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">d_is_neighbour</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">loc</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dx</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dx</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">dy</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dy</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">dz</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dz</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">cutoff</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// faster to always save pairs - even if not an actual pair.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#000">d_potential_pairs_i</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">loc</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">d_potential_pairs_j</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">loc</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">j</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">loc</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">nvtxRangePop</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">nvtxRangePush</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;compact potential pairs&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">potential_pairs_i</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">erase</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">remove_if</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">potential_pairs_i</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#000">potential_pairs_i</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#000">is_neighbour</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">logical_not</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#000">potential_pairs_i</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">potential_pairs_j</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">erase</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">remove_if</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">potential_pairs_j</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#000">potential_pairs_j</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#000">is_neighbour</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">logical_not</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	    <span style="color:#000">potential_pairs_j</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">nvtxRangePop</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// return indices as a pair of vectors
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#000">pairs_out</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">move</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">potential_pairs_i</span><span style="color:#000;font-weight:bold">),</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">move</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">potential_pairs_j</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// end of the range started at the start of the function
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">nvtxRangePop</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">pairs_out</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// cpu version
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">typename</span> <span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#000">find_pairs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">z</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">F</span> <span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">F</span> <span style="color:#000">cell_size</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cutoff</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">F</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cells_per_cutoff</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// get grid dims
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">F</span> <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]},</span> <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">-=</span> <span style="color:#000">F</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2.</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cell_size</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">F</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2.</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cell_size</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cell_size</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cell_size</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cell_size</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cell_size</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// assign particles to grid
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cell_size</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cell_size</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cell_size</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// sorting particles
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">sort</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">](</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">gidx_tmp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">xtmp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">()),</span> <span style="color:#000">ytmp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">()),</span> <span style="color:#000">ztmp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">z</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">gidx_tmp</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">permute</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">xtmp</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">permute</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ytmp</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">permute</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ztmp</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">permute</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">gidx_tmp</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xtmp</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ytmp</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ztmp</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// find mapping
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">size_t</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">prev_cell</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">this_cell</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">prev_cell</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">this_cell</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">prev_cell</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">size_t</span> <span style="color:#000">maxval</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">maxval</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">maxval</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">maxval</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">maxval</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#000">pairs</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">npairs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">my_idx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">F</span> <span style="color:#000">xi</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">yi</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">zi</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">didx_x</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">cells_per_cutoff</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">didx_x</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">didx_x</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">didx_y</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">cells_per_cutoff</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">didx_y</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">cells_per_cutoff</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">didx_y</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">startidx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">my_idx</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">didx_x</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">didx_y</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">cells_per_cutoff</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">startidx</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">startidx</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">search_cube_len</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">F</span> <span style="color:#000">dx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">dy</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">yi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">dz</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">zi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dx</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dx</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">dy</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dy</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">dz</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dz</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">cutoff</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000">pairs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">first</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">push_back</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000">pairs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">second</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">push_back</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#000">npairs</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">didx_y</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">cells_per_cutoff</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">didx_y</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">didx_y</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">startidx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">my_idx</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">didx_y</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">cells_per_cutoff</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">startidx</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">startidx</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">search_cube_len</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">F</span> <span style="color:#000">dx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">dy</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">yi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">dz</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">zi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dx</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dx</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">dy</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dy</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">dz</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dz</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">cutoff</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000">pairs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">first</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">push_back</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000">pairs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">second</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">push_back</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000">npairs</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">my_idx</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">cells_per_cutoff</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">F</span> <span style="color:#000">dx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">dy</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">yi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">dz</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">zi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dx</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dx</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">dy</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dy</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">dz</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dz</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">cutoff</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">pairs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">first</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">push_back</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">pairs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">second</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">push_back</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">npairs</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">pairs</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="democpp">
  demo.cpp
  <a class="anchor" href="#democpp">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;find_pairs.hpp&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;iostream&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;chrono&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;random&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[])</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">size_t</span> <span style="color:#000">nx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ny</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nz</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ntotal</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">nx</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ny</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">nz</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">double</span> <span style="color:#000">dx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1.</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">nx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cutoff</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3.</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dx</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">host_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">double</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">h_x</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ntotal</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">h_y</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ntotal</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">h_z</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ntotal</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">uniform_real_distribution</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">double</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">unif</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0.</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1.</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">default_random_engine</span> <span style="color:#000">re</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">cout</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#4e9a06">&#34;test&#34;</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#4e9a06">&#39;\n&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">ntotal</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">h_x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">unif</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">re</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">h_y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">unif</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">re</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">h_z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">unif</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">re</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// for validation
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">double</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">d_x</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">h_x</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000">d_y</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">h_y</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000">d_z</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">h_z</span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// wait for copy to device to finish
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">cudaDeviceSynchronize</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">auto</span> <span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">chrono</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">high_resolution_clock</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">now</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#000">pairs_gpu</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">find_pairs_demo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d_x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d_y</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d_z</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">cudaDeviceSynchronize</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">auto</span> <span style="color:#000">stop</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">chrono</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">high_resolution_clock</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">now</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">auto</span> <span style="color:#000">duration</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">chrono</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">duration_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">chrono</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">microseconds</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stop</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">cout</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#4e9a06">&#34;  GPU thrust:</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">cout</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#4e9a06">&#34;    Time taken by function: &#34;</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#000">duration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">count</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#4e9a06">&#34; us</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">cout</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#4e9a06">&#34;    Number of pairs: &#34;</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#000">pairs_gpu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">first</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#4e9a06">&#39;\n&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// validate
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">double</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">vx</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">h_x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">()),</span> <span style="color:#000">vy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">h_y</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">()),</span> <span style="color:#000">vz</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">h_z</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">size_t</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">h_x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">vx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">h_x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">vy</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">h_y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">vz</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">h_z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">pair_i</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ntotal</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">pair_j</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ntotal</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">chrono</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">high_resolution_clock</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">now</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#000">pairs_cpu</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">find_pairs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vy</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vz</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">stop</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">chrono</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">high_resolution_clock</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">now</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">duration</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">chrono</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">duration_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">chrono</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">microseconds</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stop</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">cout</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#4e9a06">&#34;  CPU:</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">cout</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#4e9a06">&#34;    Time taken by function: &#34;</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#000">duration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">count</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#4e9a06">&#34; us</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">cout</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#4e9a06">&#34;    Number of pairs: &#34;</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#000">pairs_cpu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">first</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#4e9a06">&#39;\n&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div></article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">


  <div><a class="flex align-center" href="https://github.com/edoyango/personal-webpage/commit/4576878ab5269cc1a98e8acb9d21586910993df4" title='Last modified by Edward Yang | December 1, 2025' target="_blank" rel="noopener">
      <img src="/worknotes/svg/calendar.svg" class="book-icon" alt="Calendar" />
      <span>December 1, 2025</span>
    </a>
  </div>



  <div>
    <a class="flex align-center" href="https://github.com/edoyango/personal-webpage/edit/main/worknotes/content/docs/cuda/frn-thrust.md" target="_blank" rel="noopener">
      <img src="/worknotes/svg/edit.svg" class="book-icon" alt="Edit" />
      <span>Edit this page</span>
    </a>
  </div>


</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#fixed-radius-neighbour-search-using-thrust">Fixed-Radius Neighbour Search Using Thrust</a>
      <ul>
        <li><a href="#why-thrust">Why Thrust?</a></li>
        <li><a href="#the-algorithm">The algorithm</a></li>
        <li><a href="#the-details">The details</a>
          <ul>
            <li><a href="#defining-algorithm-constants">Defining Algorithm Constants</a></li>
            <li><a href="#finding-the-grid-extents">Finding the grid extents</a></li>
            <li><a href="#mapping-the-particles-to-the-grid-and-sorting">Mapping the particles to the grid and sorting</a></li>
            <li><a href="#finding-the-cell-end-indices">Finding the cell end indices</a></li>
            <li><a href="#generating-potential-pairs">Generating potential pairs</a></li>
          </ul>
        </li>
        <li><a href="#results">Results</a>
          <ul>
            <li><a href="#timings-on-more-nvidia-gpus">Timings on more NVIDIA GPUs</a></li>
            <li><a href="#timings-with-amd-gpus">Timings with AMD GPUs</a></li>
            <li><a href="#memory-saving-strategies">Memory saving strategies?</a></li>
          </ul>
        </li>
        <li><a href="#conclusions">Conclusions</a></li>
        <li><a href="#full-code">Full code</a>
          <ul>
            <li><a href="#find_pairshpp">find_pairs.hpp</a></li>
            <li><a href="#democpp">demo.cpp</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












