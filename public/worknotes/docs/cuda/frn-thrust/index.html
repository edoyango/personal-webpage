<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Fixed-Radius Neighbour Search Using Thrust # This page describes how one might implement the pair-finding algorithm described by Simon Green (2010). Many implementations of Simon&rsquo;s work exists, such as the FRNN Python package.
Why Thrust? # I would argue that there is a fairly strong incentive to make GPU-accelerated codes portable across different hardware platforms. At the time of writing, NVIDIA GPUs are becoming more challenging to get a hold of, and are more expensive relative to their competition (i.">
<meta name="theme-color" content="#FFFFFF">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="Fixed-Radius Neighbour Search Using Thrust" />
<meta property="og:description" content="Fixed-Radius Neighbour Search Using Thrust # This page describes how one might implement the pair-finding algorithm described by Simon Green (2010). Many implementations of Simon&rsquo;s work exists, such as the FRNN Python package.
Why Thrust? # I would argue that there is a fairly strong incentive to make GPU-accelerated codes portable across different hardware platforms. At the time of writing, NVIDIA GPUs are becoming more challenging to get a hold of, and are more expensive relative to their competition (i." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/worknotes/docs/cuda/frn-thrust/" /><meta property="article:section" content="docs" />



<title>Fixed-Radius Neighbour Search Using Thrust | Ed&#39;s Space - Notes</title>
<link rel="manifest" href="/worknotes/manifest.json">
<link rel="icon" href="/worknotes/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/worknotes/book.min.16fde4d05cd1cf758f445b62581a359a2b0aa3a8b1be4966bf73546658560a86.css" >
  <script defer src="/worknotes/flexsearch.min.js"></script>
  <script defer src="/worknotes/en.search.min.5720fcdb3b8c15d19099a7ac209d3373550a1b04bbf08696f3860b86d969eb9a.js" ></script>

  <script defer src="/worknotes/sw.min.97afbbb840f8817a158b86f13f6a071d4ddf793bff2b4832f0bea2832fcea52b.js" ></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/worknotes/"><span>Ed&#39;s Space - Notes</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  



  
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/f-cpp/" class="">A Basic Comparison of C&#43;&#43; vs Fortran</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-66e324409520a0737bd43cc569874f83" class="toggle"  />
    <label for="section-66e324409520a0737bd43cc569874f83" class="flex justify-between">
      <a role="button" class="">Investigating Manual Vectorization for SPH</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/manual-vectorization/motivation/" class="">Motivation</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/manual-vectorization/addition/" class="">Vectorizing Array Addition</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/manual-vectorization/sumreduce/" class="">Vector Sum Reduction</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/manual-vectorization/faster-sumreduce/" class="">Faster Vector Sum Reduction</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/manual-vectorization/sweep/" class="">Vectorizing A Simple Pair Sweep</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/manual-vectorization/cll-avx512/" class="">Vectorizing Cell-based Pair Search</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-0a528f07e9a082a49af09fdd51803971" class="toggle"  />
    <label for="section-0a528f07e9a082a49af09fdd51803971" class="flex justify-between">
      <a role="button" class="">Useful code snippets</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/useful/fixed-cutoff-direct-pair-search/" class="">Direct pair search</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/useful/fixed-cutoff-cell-lists-pair-search/" class="">Cell list pair search</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/useful/fixed-cutoff-cell-lists-pair-searchhalf-search/" class="">Cell list pair search - reducing search space</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/useful/grid-rows-spatial-hashing/" class="">grid dimension hashing</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/useful/fixed-cutoff-pair-search-noifs/" class="">Cell lists pair search without &#34;if&#34;</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/useful/z-curve-spatial-hashing/" class="">Z-curve hashing</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/caf/" class="">Coarray Fortran Things</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-dd9822fd3605fad8b87900cb6ce57d44" class="toggle" checked />
    <label for="section-dd9822fd3605fad8b87900cb6ce57d44" class="flex justify-between">
      <a role="button" class="">CUDA Programming</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/cuda-wsl/" class="">CUDA &#43; NVHPC on WSL</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/frn-thrust/" class="active">Fixed-Radius Neighbour Search Using Thrust</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/" class="">nvfortran and nvc&#43;&#43; reference codes</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/deviceQuery/" class="">deviceQuery</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/precision_m/" class="">precision_m</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/error/" class="">Error Handling</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/limitingFactor/" class="">limitingFactor</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/peakBandwidth/" class="">peakBandwidth</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/bandwidthTest/" class="">bandwidthTest</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/MemCpy/" class="">MemCpy</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/testAsync/" class="">testAsync</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/offsetNStride/" class="">offsetNStride</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/strideTexture/" class="">strideTexture</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/sharedExample/" class="">sharedExample</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/checkP2pAccess/" class="">checkP2PAccess</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/directTransfer/" class="">directTransfer</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/p2pBandwidth/" class="">p2pBandwidth</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/mpiDevices/" class="">mpiDevices</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/mpiDeviceUtil/" class="">mpiDeviceUtil</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/transposeMPI/" class="">transposeMPI</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-60fac35d986ec8cfa3e69ae7d6bd89c7" class="toggle"  />
    <label for="section-60fac35d986ec8cfa3e69ae7d6bd89c7" class="flex justify-between">
      <a href="/worknotes/docs/cfdem/" class="">CFDEM</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cfdem/cavitycfdem/" class="">OpenFOAM cavity case to CFDEM</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cfdem/snappyhexmesh/" class="">Snappy Hex Mesh Basics</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cfdem/liggghts-intel-comp/" class="">Speeding Up LIGGGHTS with Intel Compilers and Compiler Options</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-a7de28c45dd79595ad56b835eba0d6dc" class="toggle"  />
    <label for="section-a7de28c45dd79595ad56b835eba0d6dc" class="flex justify-between">
      <a role="button" class="">Raspberry Pis</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/pi/trim-jetsonnano/" class="">Reducing Jetson Nano OS for Server</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/pi/webserver/" class="">Setting Up Public Webserver on Raspberry Pi</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/pi/slurm-cluster/" class="">Setting Up Raspberry Pi Slurm Cluster</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>











  
<ul>
  
  <li>
    <a href="https://github.com/edoyango"  target="_blank" rel="noopener">
        GitHub
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/worknotes/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Fixed-Radius Neighbour Search Using Thrust</strong>

  <label for="toc-control">
    
    <img src="/worknotes/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#fixed-radius-neighbour-search-using-thrust">Fixed-Radius Neighbour Search Using Thrust</a>
      <ul>
        <li><a href="#why-thrust">Why Thrust?</a></li>
        <li><a href="#the-algorithm">The algorithm</a></li>
        <li><a href="#the-details">The details</a>
          <ul>
            <li><a href="#finding-the-grid-extents">Finding the grid extents</a></li>
            <li><a href="#mapping-the-particles-to-the-grid-and-sorting">Mapping the particles to the grid and sorting</a></li>
            <li><a href="#finding-the-cell-end-indices">Finding the cell end indices</a></li>
            <li><a href="#generating-potential-pairs">Generating potential pairs</a></li>
          </ul>
        </li>
        <li><a href="#discussion">Discussion</a></li>
        <li><a href="#full-code">Full code</a>
          <ul>
            <li><a href="#find_pairshpp">find_pairs.hpp</a></li>
            <li><a href="#democpp">demo.cpp</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="fixed-radius-neighbour-search-using-thrust">
  Fixed-Radius Neighbour Search Using Thrust
  <a class="anchor" href="#fixed-radius-neighbour-search-using-thrust">#</a>
</h1>
<p>This page describes how one might implement the pair-finding algorithm described by 
  <a href="https://developer.download.nvidia.com/assets/cuda/files/particles.pdf">Simon Green (2010)</a>.
Many implementations of Simon&rsquo;s work exists, such as the 
  <a href="https://github.com/lxxue/FRNN">FRNN Python package</a>.</p>
<h2 id="why-thrust">
  Why Thrust?
  <a class="anchor" href="#why-thrust">#</a>
</h2>
<p>I would argue that there is a fairly strong incentive to make GPU-accelerated codes portable across different
hardware platforms. At the time of writing, NVIDIA GPUs are becoming more challenging to get a hold of, and are
more expensive relative to their competition (i.e., AMD and Intel GPUs). Consequently, it is becoming harder to justify
writing code exclusively using the CUDA ecosystem.</p>
<p>While Thrust was originally exclusive to NVIDIA platforms, AMD have developed 
  <a href="https://github.com/ROCm/rocThrust">their own implementation</a>
and Intel&rsquo;s OneDPL provides similar functionality with an almost identical API (see 
  <a href="https://www.intel.com/content/www/us/en/developer/articles/technical/migrating-thrust-to-sycl-and-onedpl.html?cid=iosm&amp;source=linkedin&amp;campid=2022_oneapi_some_q1-q4&amp;content=100003621273984&amp;icid=satg-obm-campaign&amp;linkId=100000172866525">their article</a>
describing how to port Thrust applications to OneDPL).</p>
<p>Thrust is also high-level and aims to replicate the STL and includes many optimised algorithms such as sorting and
scanning, which will be leveraged here. This means using Thrust avoids the need of having to self-write these algorithms
(like what the FRNN package does), is comparatively easy to understand for existing C++ developers, and is portable.</p>
<h2 id="the-algorithm">
  The algorithm
  <a class="anchor" href="#the-algorithm">#</a>
</h2>
<p>Simon&rsquo;s article already does a good job of describing how the pair-search algorithm is supposed to work, so I will defer
the high-level description to that paper.</p>
<p>However, Simon&rsquo;s paper stops at creating the uniform grid using sorting, and creating an array indicating the starts of the
cells. Here, I show the steps beyond.</p>
<p>In this algorithm, after the particle-to-grid mapping is created, we determine</p>
<h2 id="the-details">
  The details
  <a class="anchor" href="#the-details">#</a>
</h2>
<p>Here, I&rsquo;m writing the algorithm inside a function, assuming it will be called elsewhere. The function will take in
three <code>thrust::device_vector&lt;F&gt;</code>, where <code>F</code> is a template type. It will also take a singular <code>F</code> value, which represents
the cutoff radius which defines an interacting pair. Importantly, the input device vectors must be passed by reference,
because they will be permuted based on the sorting. The function will return a <code>std::pair</code> of device vectors, where each
device vector represents one of the sides of the output pairs found. A template parameter, <code>I</code> will be used to specify
the integer type of the indices. Thus, the function definition will look like:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;thrust/device_vector.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;utility&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#8f5902;font-style:italic">// we will add more includes later
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">typename</span> <span style="color:#000">F</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">typename</span> <span style="color:#000">I</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">I</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">I</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#000">find_pairs</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">z</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">F</span> <span style="color:#000">cutoff</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// body ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="finding-the-grid-extents">
  Finding the grid extents
  <a class="anchor" href="#finding-the-grid-extents">#</a>
</h3>
<p>The first step is to find the extents of the grid that encapsulates the particle cloud. Thrust offers the
<code>minmax_element</code> function in the <code>thrust/extrema.h</code> header file, which can be used here:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// declare the min-max extent arrays
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">F</span> <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// find the extents
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">auto</span> <span style="color:#000">res</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">minmax_element</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">first</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">second</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">res</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">minmax_element</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">first</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">second</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">res</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">minmax_element</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">z</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">first</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">second</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// extend the grid to ensure there are buffer cells
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">-=</span> <span style="color:#000">F</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2.</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">F</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2.</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Important to note here that the return type of <code>thrust::minmax_element</code> is a pair of <code>device_ptr</code> which must be
dereferenced to be stored in the <code>mingrid</code>, <code>maxgrid</code> arrays. <code>minmax_element</code> is called three times - one for each
coordinate. Finally, the minima and maxima of the grid are extended so that when adjacent cells of particles are
searched later, they stay within the bounds. Admittedly, the choice of extending the grid by 2 cells in each direction
is a little conservative.</p>
<p>Before continuing to the next step, we can calculate the number of cells in each direction:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Which rounds up the number of grid cells. Optionally, you can update the maxima of the grid, but isn&rsquo;t really necessary
as the maxima aren&rsquo;t used from herein.</p>
<h3 id="mapping-the-particles-to-the-grid-and-sorting">
  Mapping the particles to the grid and sorting
  <a class="anchor" href="#mapping-the-particles-to-the-grid-and-sorting">#</a>
</h3>
<p>This is the step that Simon&rsquo;s paper illustrates. First we must determine the grid cell indices that each cell belongs
to. As per Simon&rsquo;s paper, we&rsquo;re using a scalar &ldquo;hash&rdquo; to map particles to grid cells. This 1D hash is beneficial for two
reasons:</p>
<ol>
<li>the algorithm itself is sped up as less data is transferred when retrieving the grid indices</li>
<li>spatial locality is improved.</li>
</ol>
<p>First assigning particles to grid cells:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// declare array to store particles&#39; grid indices
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_ptr</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">d_gidx</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">()};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// map particles to grid
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">transform</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">make_zip_iterator</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">make_tuple</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">())),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">make_zip_iterator</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">make_tuple</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">())),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">__device__</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">detail</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">tuple_of_iterator_references</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&amp;&gt;</span> <span style="color:#000">in</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">get</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">get</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">get</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>There&rsquo;s a lot going on here so let&rsquo;s break it down:</p>
<ul>
<li><code>thrust::transform</code>
<ul>
<li>is used to transform the values of an input iterator, and place them in an output iterator (in this case, <code>gidx</code>).</li>
</ul>
</li>
<li><code>thrust::make_zip_iterator(thrust::make_tuple(...))</code>
<ul>
<li>this &ldquo;packs&rdquo; the forward iterators as provided by <code>x/y/z.begin()</code>, so that each <code>thrust::transform</code> iteration has
access to the corresponding x, y, and z values.</li>
</ul>
</li>
<li><code>gidx.begin()</code>
<ul>
<li>specifies that the output is to be placed in <code>gidx</code>.</li>
</ul>
</li>
<li><code>[=] __device__ (...)</code>
<ul>
<li>is a lambda (can be used since compute capability 7.0). <code>[=]</code> specifies that external values should be captured
by value. Capturing external variables by reference is unavailable in a CUDA lambda. The <code>__device__</code> attribute
specifes that the generated lambda instructions is for the device aka GPU.</li>
<li>the lambda accepts a <code>thrust::detail::tuple_of_iterator_references</code>, which is a tuple of each of the x, y, z
values. These values, are retrieved with the <code>thrust::get&lt;i&gt;</code> function, where <code>i</code> is an index.</li>
<li><code>static_cast&lt;I&gt;((thrust::get&lt;i&gt;(in) - mingrid[i])/cutoff)</code> is obtaining the grid index in the <code>i</code>th direction.
The &ldquo;hashing&rdquo; function ensures that that the grid is &ldquo;column major&rdquo; i.e., the third index is consecutive in memory.</li>
</ul>
</li>
</ul>
<p>Now that each particle has been assigned a grid cell index, we can sort the grid cells, and obtain a mapping of old
array indices to new ones.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// initialize permute
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">sequence</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">());</span> <span style="color:#8f5902;font-style:italic">// e.g., 0 1 2 3 4
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// sort gidx
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">sort_by_key</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* e.g. before gidx = 1 9 2 8 3, permute = 0 1 2 3 4
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">            after  gidx = 1 2 3 8 9, permute = 0 2 4 3 1 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// gather old positions into new ones
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">gather</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* e.g. before x = 0.1 0.5 0.1 0.5 0.3, tmp = ?   ?   ?   ?   ?
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">            after  x = &#34;                 &#34;, tmp = 0.1 0.1 0.3 0.5 0.5 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">copy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// e.g.        x = 0.1 0.1 0.3 0.5 0.5
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// repeat for y, z
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">gather</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">copy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">gather</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">copy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">());</span>
</span></span></code></pre></div><p>Hopefully the examples in the comments are enough to illustrate what&rsquo;s going on. But, at a high-level, the <code>permute</code>
vector is initialized with numbers 0 to the length of permute (which is the same as gidx). Then, <code>thrust::sort_by_key</code>
sorts the <code>gidx</code> vector, as well as updating <code>permute</code> such that the <code>i</code>th element of <code>permute</code> corresponds to the old
position of the <code>i</code>th element in the now sorted <code>gidx</code> vector. <code>thrust::gather</code> is then used to permute the old <code>x/y/z</code>
vectors into their new positions in a temporary vector, which is then copied back to the original vector using
<code>thrust::copy</code>. Unfortunately, there&rsquo;s no way that I know of to do this in a single function.</p>
<h3 id="finding-the-cell-end-indices">
  Finding the cell end indices
  <a class="anchor" href="#finding-the-cell-end-indices">#</a>
</h3>
<p>In Simon&rsquo;s paper, the start of each cell in <code>gidx</code> is obtained. But here, the end of each cell is obtained. The ends
are recorded instead of the starts as the algorithms are a little more convenient to write.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// initialize cell_ends vector
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">fill</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// create device_ptr needed for lambda
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_ptr</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">d_cell_ends</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">()};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">for_each</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">counting_iterator</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">counting_iterator</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">()),</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">__device__</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">this_cell</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_gidx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">prev_cell</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_gidx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">this_cell</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">prev_cell</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">d_cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">prev_cell</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// e.g. gidx = 1 2 3 8 9, cell_ends = 0 1 2 3 0 0 0 0 0 4 5 0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">inclusive_scan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">maximum</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// e.g. cell_ends = 0 1 2 3 3 3 3 3 3 4 5 5
</span></span></span></code></pre></div><p>After the initialization of the <code>cell_ends</code> vector (which is hopefully self-explanatory), two device pointers are
generated, pointing to the underlying data of <code>cell_ends</code> and <code>gidx</code>.</p>
<p>The <code>thrust::for_each</code> function is effectively a <code>for</code> loop and serves a similar purpose to <code>std::for_each</code>.
<code>thrust::counting_iterator</code> is used to specify that range of the loop. A lambda is used to define the work done in each
iteration of the loop, which is to first check whether the <code>i</code>th entry of <code>gidx</code> is different from the previous entry.
If it is different, that means the <code>i</code>th element is recorded as the end of the cell <code>gidx[i-1]</code>, so <code>cell_ends</code> is
updated. Note:</p>
<ul>
<li>lambdas cannot use the <code>device_vector</code> accessor operator (<code>[]</code>), hence the need to create a <code>device_ptr</code>.</li>
<li>after the <code>for_each</code>, <code>cell_ends</code> possesses zeroes in cell indices which aren&rsquo;t in <code>gidx</code>.</li>
</ul>
<p><code>cell_ends</code> can be used even with zeroes, but it&rsquo;s more convenient to ensure that they are filled with something
meaningful. Here, the intention is to use <code>cell_ends</code> to specify the range of particle indices that belong to a cell.
For example, if <code>cell_ends = 0 1 2 3 0 0 0 0 0 4 5 0</code>, then the start of cell 3 is found at <code>cell_ends[2]</code>, and the end
is found at <code>cell_ends[3]</code> (open-interval). If the zeroes remain, then for cell 8, the the start may be specified as
<code>cell_ends[7] = 0</code>, and the end is <code>cell_ends[8] = 4</code>, which is not correct. If the zeroes are &ldquo;filled&rdquo; with a
sensible value, then we can use <code>cell_ends[i-1]</code> as the first particle index for cell <code>i</code>.</p>
<p>Hence, <code>thrust::inclusive_scan</code>, with a <code>thrust:maximum</code> binary functor fills in the zeroes with the largest value
up to that index. In the previous example, you should be able to see that <code>cell_ends[7] = 3</code>, providing the correct
starting particle index to use for cell 8.</p>
<h3 id="generating-potential-pairs">
  Generating potential pairs
  <a class="anchor" href="#generating-potential-pairs">#</a>
</h3>
<p>In my version of the finding pair algorithm, I avoid using atomics as they can degrade performance significantly in
cases where there is high-contention (i.e., many threads are trying to update the same variable). In addition, AMD
GPUs don&rsquo;t do atomic operations that well. To avoid atomics, I generate potential pairs first, and then compacting these
pairs into realised pairs.</p>
<p>When generating potential pairs, it&rsquo;s important to understand that for each particle, only half the neighbouring cells
need to be searched. This is because finding pairs is symmetric i.e., if one particle is found to be paired with
another, I don&rsquo;t need to do the reverse check. Consequently, for each particle, only the &ldquo;lowest&rdquo; 14 cells are searched
for neighbours (one of those cells being its own). See the figure below for an illustration and note that cell indices
are relative to the particle of interest&rsquo;s cell.</p>
<p>
  <img src="/worknotes/imgs/grid-search-space.png" alt="Diagram showing the cells searched for neighbours" /></p>
<p>Given that each particle will check a cell for neighbours, we must first figure out how many checks will be done.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// initialize number of checks
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">size_t</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">14</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_ptr</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">size_t</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">d_nchecks</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">()};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// populate nchecks
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">for_each</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">counting_iterator</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">counting_iterator</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">()),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">__device__</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">loc</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">14</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">my_idx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_gidx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">start_idx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">my_idx</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">14</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// which cell am i comparing to?
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">idxz</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rem</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">idxy</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rem</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">idxx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rem</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">neighbour_idx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">start_idx</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">idxx</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">idxy</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">idxz</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// get the starting particle index
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">start_pidx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">neighbour_idx</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">end_pidx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">j</span><span style="color:#ce5c00;font-weight:bold">==</span><span style="color:#0000cf;font-weight:bold">13</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#f57900">i</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#000">d_cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">neighbour_idx</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">d_nchecks</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">loc</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">size_t</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">end_pidx</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">start_pidx</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>After <code>nchecks</code> is initialized, a <code>thrust::for_each</code> call is used, using the <code>thrust::counting_iterator</code> to specify the
iteration range. As many threads as there are particles is launched, where each thread is responsible for generating
the number checks to be done for the relevant neighbouring cells.</p>
<p>Now, we can get the total number of checks to be performed:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">size_t</span> <span style="color:#000">last_ncheck_prescan</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">back</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">exclusive_scan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">size_t</span> <span style="color:#000">nchecks_total</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">last_ncheck_prescan</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">back</span><span style="color:#000;font-weight:bold">();</span>
</span></span></code></pre></div><p>The <code>thrust::exclusive_scan</code> turns the <code>nchecks</code> vector into a vector that specifies the starting index within the
potential pair list that correspond to a particle <code>i</code> and one of its neighbouring cells. With that information, the
actual generation of potential pairs can be performed.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// initialize potential pair list
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">potential_pairs_i</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nchecks_total</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">potential_pairs_j</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nchecks_total</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_ptr</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">d_potential_pairs_i</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">potential_pairs_i</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">()),</span> <span style="color:#000">d_potential_pairs_j</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">potential_pairs_j</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// allocate vector to flag which potential pair is an actual pair
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">is_neighbour</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nchecks_total</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_ptr</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">d_is_neighbour</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">is_neighbour</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">()};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">fill</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">is_neighbour</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">is_neighbour</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#204a87">false</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// search potential pairs and flag actual pairs
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">for_each</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">counting_iterator</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">counting_iterator</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">()),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">__device__</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ii</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// calculate wich particle and neighbour cell hash (in relative search-space coordinate system)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ii</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">14</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">neighbour_cell</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ii</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#0000cf;font-weight:bold">14</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// get my particle&#39;s cell and determine neighbour cell 3d coordinate (in relative search-space coordinate system)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">my_idx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_gidx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">start_idxz</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">neighbour</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rem</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">neighbour</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start_idxx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rem</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start_idxy</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rem</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// convert neighbour cell relative coordinate to global coordinates
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">neighbour_idx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">my_idx</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start_idxx</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start_idxy</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">start_idxz</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// determine neighbour particle index range to check
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">start_idx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">neighbour_idx</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">end_idx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">neighbour</span><span style="color:#ce5c00;font-weight:bold">==</span><span style="color:#0000cf;font-weight:bold">13</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#f57900">i</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#000">d_cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">neighbour_idx</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// identify which spot in potential pair list to populate
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">size_t</span> <span style="color:#000">loc</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_ncheck</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">ii</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ftype</span> <span style="color:#000">xi</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">yi</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">zi</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">start_idx</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">end_idx</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// check j particle
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">ftype</span> <span style="color:#000">dx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">d_x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">dy</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">yi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">d_y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">dz</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">zi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">d_z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">d_is_neighbour</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">loc</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dx</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dx</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">dy</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dy</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">dz</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dz</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">cutoff</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// only save data if i and j is a pair. Saving data is expensive.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">d_is_neighbour</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">loc</span><span style="color:#000;font-weight:bold">])</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000">d_potential_pairs_i</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">loc</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000">d_potential_pairs_j</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">loc</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">j</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">loc</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>This step is quite complex, but hopefully the comments are sufficient. The potential pair list can be compacted
with a <code>copy_if</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// calculate number of real pairs
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">npairs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">reduce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">is_neighbour</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">is_neighbour</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">plus</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// clear unneeded arrays
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clear</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">shrink_to_fit</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clear</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">shrink_to_fit</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// initialize result
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">pair_i</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">npairs</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">pair_j</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">npairs</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#000">pairs_out</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pair_i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pair_j</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// save result
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">copy_if</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">potential_pairs_i</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">potential_pairs_i</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">is_neighbour</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">pairs_out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">first</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">identity</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">copy_if</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">potential_pairs_j</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">potential_pairs_j</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">is_neighbour</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">pairs_out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">second</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">identity</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">pairs</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><h2 id="discussion">
  Discussion
  <a class="anchor" href="#discussion">#</a>
</h2>
<p>The performance of the code is pretty decent. A pair list can be generated under the following conditions in
approximately 65ms:</p>
<ul>
<li>1,000,000 particles</li>
<li>positions generated randomly such that each coordinate is between 0 and 1</li>
<li>positions stored as double precision (relevant in simulation codes)</li>
<li>cutoff radius is 0.03 (3 times the average particle spacing).</li>
<li>run on A100</li>
<li>compiled with <code>nvcc -O3 --use_fast_math</code> using CUDA 12.2 with <code>gcc</code> 11.2.0 used as the base.</li>
</ul>
<p>Interestingly, the same code will perform about 20% better on half an MI250X (half because MI250X is effectively
two GPUs on a single die) when the cutoff radius is 2x the average spacing, but starts to perform worse than the
A100 as the radii increases.</p>
<p>Relative to single-core CPU code, the thrust code is about 20x (maybe a bit less - depending on how it&rsquo;s programmed).
I should also note that as the number of particles in the system increase, so does the speedup relative to the CPU code.</p>
<p>The drawback of the algorithm here is that it consumes a lot of memory. On average, the potential pair list will
consume 81/(4pi) ~ 6.5x more memory than the actual pair list (this is due to the search space being a cube of
length 3r, and the actual &ldquo;pair&rdquo; space being a sphere of radius r).</p>
<p>As a whole, I find thrust not too difficult to use, as someone who&rsquo;s been using C++ for 1.5 years. It abstracts a lot of
the GPU programming, and gives access to very useful and optimised algorithms, while also being fairly platform
portable. i only have two main gripes with it. The first is that making the low-level features unavailable makes it a
little difficult to get the best performance for complex kernels, but I believe that to be intentional and part of the
design. And anyway, there&rsquo;s nothing stopping you from writing your own kernels (possibly making the code less portable).
The second issue is the lack of examples. It&rsquo;s just not that easy for a C++ beginner to write or understand how to use
Thrust, although ChatGPT makes it a lot easier.</p>
<p>I&rsquo;m tempted to compare Thrust with Kokkos, which also aims to provide a performance portable programming framework.
Kokkos is much more beginner friendly, with a long spiel about the programming model, good quality examples, and lots of
public training material. It also gives gives access to low-level features such as shared memory and block through
abstractions such as scratch space and teams. However, while most of their key algorithms like <code>Kokkos::parallel_for</code>,
and <code>Kokkos::parallel_reduce</code> - equivalent to <code>thrust::for_each</code> and <code>thrust::reduce</code>, respectively; perform really
well, others like <code>Kokkos::parallel_scan</code> and <code>Kokkos::sort</code> are unusable in performance-critical code. In cases where
scanning and sorting is critical, it might be better to use Thrust, or mix the frameworks together (which is also very
easy).</p>
<h2 id="full-code">
  Full code
  <a class="anchor" href="#full-code">#</a>
</h2>
<h3 id="find_pairshpp">
  find_pairs.hpp
  <a class="anchor" href="#find_pairshpp">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;thrust/host_vector.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;thrust/device_vector.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;thrust/sort.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;thrust/gather.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;thrust/execution_policy.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;thrust/iterator/counting_iterator.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;thrust/async/reduce.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;utility&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// thrust version
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">typename</span> <span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#000">find_pairs_demo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">z</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">F</span> <span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_ptr</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">d_x</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">()},</span> <span style="color:#000">d_y</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">()},</span> <span style="color:#000">d_z</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">z</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">()};</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// find min-max extents
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">F</span> <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">auto</span> <span style="color:#000">res</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">minmax_element</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">first</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">second</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">res</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">minmax_element</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">first</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">second</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">res</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">minmax_element</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">z</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">first</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">second</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">-=</span> <span style="color:#000">F</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2.</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">F</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2.</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// assign particles to grid in block scope to manage scope of scratch space data.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_ptr</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">d_gidx</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">()};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// map particles to grid
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">transform</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">make_zip_iterator</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">make_tuple</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">())),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">make_zip_iterator</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">make_tuple</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">())),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">__device__</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">detail</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">tuple_of_iterator_references</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&amp;&gt;</span> <span style="color:#000">in</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">get</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>                       <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">get</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>                       <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">get</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">in</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// initialize permute
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">sequence</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">());</span> <span style="color:#8f5902;font-style:italic">// e.g., 0 1 2 3 4
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// sort gidx
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">sort_by_key</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">/* e.g. before gidx = 1 9 2 8 3, permute = 0 1 2 3 4
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                after  gidx = 1 2 3 8 9, permute = 0 2 4 3 1 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// gather old positions into new ones
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">gather</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">/* e.g. before x = 0.1 0.5 0.1 0.5 0.3, tmp = ?   ?   ?   ?   ?
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">                after  x = &#34;                 &#34;, tmp = 0.1 0.1 0.3 0.5 0.5 */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">copy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// e.g.        x = 0.1 0.1 0.3 0.5 0.5
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic">// repeat for y, z
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">gather</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">copy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">gather</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">copy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// initialize cell_ends vector
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">fill</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// create device_ptr needed for lambda
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_ptr</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">d_cell_ends</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">()};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">for_each</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">counting_iterator</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">counting_iterator</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">()),</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">__device__</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">this_cell</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_gidx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">prev_cell</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_gidx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">this_cell</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">prev_cell</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">d_cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">prev_cell</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// e.g. gidx = 1 2 3 8 9, cell_ends = 0 1 2 3 0 0 0 0 0 4 5 0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">inclusive_scan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">maximum</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// e.g. cell_ends = 0 1 2 3 3 3 3 3 3 4 5 5
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// initialize number of checks
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">size_t</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">14</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_ptr</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">size_t</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">d_nchecks</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">()};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// populate nchecks
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">for_each</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">counting_iterator</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">counting_iterator</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">()),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">__device__</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">loc</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">14</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">my_idx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_gidx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">start_idx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">my_idx</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">14</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// which cell am i comparing to?
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">idxz</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rem</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">idxy</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rem</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">idxx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rem</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">neighbour_idx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">start_idx</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">idxx</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">idxy</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">idxz</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic">// get the starting particle index
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>                <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">start_pidx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">neighbour_idx</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">end_pidx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">j</span><span style="color:#ce5c00;font-weight:bold">==</span><span style="color:#0000cf;font-weight:bold">13</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#f57900">i</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#000">d_cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">neighbour_idx</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">d_nchecks</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">loc</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">size_t</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">end_pidx</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">start_pidx</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">size_t</span> <span style="color:#000">last_comparison_prescan</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">back</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">exclusive_scan</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">size_t</span> <span style="color:#000">nnchecks_total</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">last_comparison_prescan</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">back</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// populate the potential pair list
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">potential_pairs_i</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nnchecks_total</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">potential_pairs_j</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nnchecks_total</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_ptr</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">d_potential_pairs_i</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">potential_pairs_i</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">()),</span> <span style="color:#000">d_potential_pairs_j</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">potential_pairs_j</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">is_neighbour</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nnchecks_total</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_ptr</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">d_is_neighbour</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">is_neighbour</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">()};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">fill</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">is_neighbour</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">is_neighbour</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">for_each</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">counting_iterator</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">counting_iterator</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">()),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">__device__</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ii</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ii</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">14</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">neighbour</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ii</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#0000cf;font-weight:bold">14</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">my_idx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_gidx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">start_idxz</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">neighbour</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rem</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">neighbour</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start_idxx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rem</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">start_idxy</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">rem</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">neighbour_idx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">my_idx</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start_idxx</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">start_idxy</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">start_idxz</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">start_idx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">neighbour_idx</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">end_idx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">neighbour</span><span style="color:#ce5c00;font-weight:bold">==</span><span style="color:#0000cf;font-weight:bold">13</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#f57900">i</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#000">d_cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">neighbour_idx</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">size_t</span> <span style="color:#000">loc</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_nchecks</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">ii</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">F</span> <span style="color:#000">xi</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">yi</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">zi</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">d_z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">start_idx</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">end_idx</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">F</span> <span style="color:#000">dx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">d_x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">dy</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">yi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">d_y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">dz</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">zi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">d_z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">d_is_neighbour</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">loc</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dx</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dx</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">dy</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dy</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">dz</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dz</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">cutoff</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">d_is_neighbour</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">loc</span><span style="color:#000;font-weight:bold">])</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000">d_potential_pairs_i</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">loc</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000">d_potential_pairs_j</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">loc</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">j</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">loc</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_future</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">npairs_async</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">async</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">reduce</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">is_neighbour</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">is_neighbour</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">plus</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Kokkos::fence();
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clear</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">shrink_to_fit</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">clear</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">nchecks</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">shrink_to_fit</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">npairs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">npairs_async</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">pair_i</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">npairs</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">pair_j</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">npairs</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#000">pairs_out</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pair_i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pair_j</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">copy_if</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">potential_pairs_i</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">potential_pairs_i</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">is_neighbour</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">pairs_out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">first</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">identity</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">copy_if</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">potential_pairs_j</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">potential_pairs_j</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">is_neighbour</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">pairs_out</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">second</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">identity</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">pairs_out</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// cpu version
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">typename</span> <span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#000">find_pairs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">z</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">F</span> <span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// get grid dims
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">F</span> <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]},</span> <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">-=</span> <span style="color:#000">F</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2.</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">F</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2.</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">maxgrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// assign particles to grid
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span>
</span></span><span style="display:flex;"><span>                  <span style="color:#204a87;font-weight:bold">static_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">mingrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">])</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// sorting particles
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">sort</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">begin</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">end</span><span style="color:#000;font-weight:bold">(),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">](</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">gidx_tmp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">F</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">xtmp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">()),</span> <span style="color:#000">ytmp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">()),</span> <span style="color:#000">ztmp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">z</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">gidx_tmp</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">permute</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">xtmp</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">permute</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ytmp</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">permute</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ztmp</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">permute</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">permute</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">gidx_tmp</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xtmp</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ytmp</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ztmp</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// find mapping
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">size_t</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">prev_cell</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">this_cell</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">prev_cell</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">this_cell</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">prev_cell</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">size_t</span> <span style="color:#000">maxval</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">maxval</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">maxval</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">maxval</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">maxval</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#000">pairs</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">npairs</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">my_idx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">gidx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">F</span> <span style="color:#000">xi</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">yi</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">zi</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">startidx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">my_idx</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">startidx</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">startidx</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">F</span> <span style="color:#000">dx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">dy</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">yi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">dz</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">zi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dx</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dx</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">dy</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dy</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">dz</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dz</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">cutoff</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">pairs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">first</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">push_back</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">pairs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">second</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">push_back</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">npairs</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">startidx</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">startidx</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">startidx</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">F</span> <span style="color:#000">dx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">dy</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">yi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">dz</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">zi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dx</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dx</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">dy</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dy</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">dz</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dz</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">cutoff</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">pairs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">first</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">push_back</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">pairs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">second</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">push_back</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">npairs</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">startidx</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">startidx</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">startidx</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">F</span> <span style="color:#000">dx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">dy</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">yi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">dz</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">zi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dx</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dx</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">dy</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dy</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">dz</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dz</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">cutoff</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">pairs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">first</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">push_back</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">pairs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">second</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">push_back</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">npairs</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">startidx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">my_idx</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">ngrid</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">startidx</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">startidx</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">F</span> <span style="color:#000">dx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">dy</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">yi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">dz</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">zi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dx</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dx</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">dy</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dy</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">dz</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dz</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">cutoff</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">pairs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">first</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">push_back</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">pairs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">second</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">push_back</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">npairs</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cell_ends</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">my_idx</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">F</span> <span style="color:#000">dx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">xi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">dy</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">yi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">dz</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">zi</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dx</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dx</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">dy</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dy</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">dz</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dz</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">cutoff</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">pairs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">first</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">push_back</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">pairs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">second</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">push_back</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">npairs</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">pairs</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="democpp">
  demo.cpp
  <a class="anchor" href="#democpp">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;find_pairs.hpp&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;iostream&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;chrono&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;random&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;thrust/host_vector.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;thrust/device_vector.h&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[])</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">size_t</span> <span style="color:#000">nx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ny</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">nz</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ntotal</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">nx</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ny</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">nz</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">cout</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nx</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#4e9a06">&#39;\n&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">double</span> <span style="color:#000">dx</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1.</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">nx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cutoff</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3.</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">dx</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">host_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">double</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">h_x</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ntotal</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">h_y</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ntotal</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">h_z</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ntotal</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">uniform_real_distribution</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">double</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">unif</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0.</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1.</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">default_random_engine</span> <span style="color:#000">re</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">ntotal</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">h_x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">unif</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">re</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">h_y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">unif</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">re</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">h_z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">unif</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">re</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// for validation
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">double</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">d_x</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">h_x</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000">d_y</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">h_y</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000">d_z</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#000">h_z</span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// wait for copy to device to finish
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">cudaDeviceSynchronize</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">auto</span> <span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">chrono</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">high_resolution_clock</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">now</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">thrust</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">device_vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#000">pairs_gpu</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">find_pairs_demo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d_x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d_y</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d_z</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">auto</span> <span style="color:#000">stop</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">chrono</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">high_resolution_clock</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">now</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">auto</span> <span style="color:#000">duration</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">chrono</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">duration_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">chrono</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">microseconds</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stop</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">cout</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#4e9a06">&#34;Time taken by function: &#34;</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#000">duration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">count</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#4e9a06">&#34; us&#34;</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">endl</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">cout</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#4e9a06">&#34;Number of pairs: &#34;</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#000">pairs_gpu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">first</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#4e9a06">&#39;\n&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// validate
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">double</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">vx</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">h_x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">()),</span> <span style="color:#000">vy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">h_y</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">()),</span> <span style="color:#000">vz</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">h_z</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">size_t</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">h_x</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">vx</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">h_x</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">vy</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">h_y</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">vz</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">h_z</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">pair_i</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ntotal</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">pair_j</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ntotal</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">chrono</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">high_resolution_clock</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">now</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#000">pairs_cpu</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">find_pairs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vy</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vz</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cutoff</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">stop</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">chrono</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">high_resolution_clock</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">now</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">duration</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">chrono</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">duration_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">chrono</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">microseconds</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stop</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">start</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">cout</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#4e9a06">&#34;Time taken by function: &#34;</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#000">duration</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">count</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#4e9a06">&#34; us&#34;</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">endl</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">cout</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#4e9a06">&#34;Number of pairs: &#34;</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#000">pairs_cpu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">first</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#4e9a06">&#39;\n&#39;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div></article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">




  <div>
    <a class="flex align-center" href="https://github.com/edoyango/personal-webpage/edit/main/worknotes/content/docs/cuda/frn-thrust.md" target="_blank" rel="noopener">
      <img src="/worknotes/svg/edit.svg" class="book-icon" alt="Edit" />
      <span>Edit this page</span>
    </a>
  </div>


</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#fixed-radius-neighbour-search-using-thrust">Fixed-Radius Neighbour Search Using Thrust</a>
      <ul>
        <li><a href="#why-thrust">Why Thrust?</a></li>
        <li><a href="#the-algorithm">The algorithm</a></li>
        <li><a href="#the-details">The details</a>
          <ul>
            <li><a href="#finding-the-grid-extents">Finding the grid extents</a></li>
            <li><a href="#mapping-the-particles-to-the-grid-and-sorting">Mapping the particles to the grid and sorting</a></li>
            <li><a href="#finding-the-cell-end-indices">Finding the cell end indices</a></li>
            <li><a href="#generating-potential-pairs">Generating potential pairs</a></li>
          </ul>
        </li>
        <li><a href="#discussion">Discussion</a></li>
        <li><a href="#full-code">Full code</a>
          <ul>
            <li><a href="#find_pairshpp">find_pairs.hpp</a></li>
            <li><a href="#democpp">demo.cpp</a></li>
          </ul>
        </li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












