<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Faster Vector Sum Reduce # In my page introducing vectorized reductions, I show how to use horizontal adds (hadd) functions to perform the reduction. However, this doesn&rsquo;t produce optimal assembly, so isn&rsquo;t the fastest way to do things.
This page will demonstrate a faster version to do each of the examples shown previously.
Single precision, SSE instructions # This section will show a faster sum-reduce example which makes use of 128-bit single precision vectors and SSE instructions.">
<meta name="theme-color" content="#FFFFFF">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="/worknotes/docs/manual-vectorization/faster-sumreduce/">
  <meta property="og:site_name" content="Ed&#39;s Space - Notes">
  <meta property="og:title" content="Faster Vector Sum Reduction">
  <meta property="og:description" content="Faster Vector Sum Reduce # In my page introducing vectorized reductions, I show how to use horizontal adds (hadd) functions to perform the reduction. However, this doesn’t produce optimal assembly, so isn’t the fastest way to do things.
This page will demonstrate a faster version to do each of the examples shown previously.
Single precision, SSE instructions # This section will show a faster sum-reduce example which makes use of 128-bit single precision vectors and SSE instructions.">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="docs">
    <meta property="article:modified_time" content="2023-08-13T14:03:27+10:00">
<title>Faster Vector Sum Reduction | Ed&#39;s Space - Notes</title>
<link rel="manifest" href="/worknotes/manifest.json">
<link rel="icon" href="/worknotes/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/worknotes/book.min.16fde4d05cd1cf758f445b62581a359a2b0aa3a8b1be4966bf73546658560a86.css" >
  <script defer src="/worknotes/flexsearch.min.js"></script>
  <script defer src="/worknotes/en.search.min.068887f2151df6dff85804fb4ed9e0dd4484497a025b54ae51f42a43eec61995.js" ></script>

  <script defer src="/worknotes/sw.min.97afbbb840f8817a158b86f13f6a071d4ddf793bff2b4832f0bea2832fcea52b.js" ></script>

  

<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/worknotes/"><span>Ed&#39;s Space - Notes</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  



  
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/f-cpp/" class="">A Basic Comparison of C&#43;&#43; vs Fortran</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-66e324409520a0737bd43cc569874f83" class="toggle" checked />
    <label for="section-66e324409520a0737bd43cc569874f83" class="flex justify-between">
      <a role="button" class="">Investigating Manual Vectorization for SPH</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/manual-vectorization/motivation/" class="">Motivation</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/manual-vectorization/addition/" class="">Vectorizing Array Addition</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/manual-vectorization/sumreduce/" class="">Vector Sum Reduction</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/manual-vectorization/faster-sumreduce/" class="active">Faster Vector Sum Reduction</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/manual-vectorization/sweep/" class="">Vectorizing A Simple Pair Sweep</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/manual-vectorization/cll-avx512/" class="">Vectorizing Cell-based Pair Search</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-0a528f07e9a082a49af09fdd51803971" class="toggle"  />
    <label for="section-0a528f07e9a082a49af09fdd51803971" class="flex justify-between">
      <a role="button" class="">Useful code snippets</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/useful/fixed-cutoff-direct-pair-search/" class="">Direct pair search</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/useful/fixed-cutoff-cell-lists-pair-search/" class="">Cell list pair search</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/useful/fixed-cutoff-cell-lists-pair-searchhalf-search/" class="">Cell list pair search - reducing search space</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/useful/grid-rows-spatial-hashing/" class="">grid dimension hashing</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/useful/fixed-cutoff-pair-search-noifs/" class="">Cell lists pair search without &#34;if&#34;</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/useful/z-curve-spatial-hashing/" class="">Z-curve hashing</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/caf/" class="">Coarray Fortran Things</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-dd9822fd3605fad8b87900cb6ce57d44" class="toggle"  />
    <label for="section-dd9822fd3605fad8b87900cb6ce57d44" class="flex justify-between">
      <a role="button" class="">CUDA Programming</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/cuda-wsl/" class="">CUDA &#43; NVHPC on WSL</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/frn-thrust/" class="">Fixed-Radius Neighbour Search Using Thrust</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/" class="">nvfortran and nvc&#43;&#43; reference codes</a>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/deviceQuery/" class="">deviceQuery</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/precision_m/" class="">precision_m</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/error/" class="">Error Handling</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/limitingFactor/" class="">limitingFactor</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/peakBandwidth/" class="">peakBandwidth</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/bandwidthTest/" class="">bandwidthTest</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/MemCpy/" class="">MemCpy</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/testAsync/" class="">testAsync</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/offsetNStride/" class="">offsetNStride</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/strideTexture/" class="">strideTexture</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/sharedExample/" class="">sharedExample</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/checkP2pAccess/" class="">checkP2PAccess</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/directTransfer/" class="">directTransfer</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/p2pBandwidth/" class="">p2pBandwidth</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/mpiDevices/" class="">mpiDevices</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/mpiDeviceUtil/" class="">mpiDeviceUtil</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cuda/reference-codes/transposeMPI/" class="">transposeMPI</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-60fac35d986ec8cfa3e69ae7d6bd89c7" class="toggle"  />
    <label for="section-60fac35d986ec8cfa3e69ae7d6bd89c7" class="flex justify-between">
      <a href="/worknotes/docs/cfdem/" class="">CFDEM</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cfdem/cavitycfdem/" class="">OpenFOAM cavity case to CFDEM</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cfdem/snappyhexmesh/" class="">Snappy Hex Mesh Basics</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/cfdem/liggghts-intel-comp/" class="">Speeding Up LIGGGHTS with Intel Compilers and Compiler Options</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-a7de28c45dd79595ad56b835eba0d6dc" class="toggle"  />
    <label for="section-a7de28c45dd79595ad56b835eba0d6dc" class="flex justify-between">
      <a role="button" class="">Raspberry Pis</a>
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/pi/yolov5-orangepi/" class="">Combining the Orange Pi 5 Pro and YOLOv5 for bird detection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/pi/trim-jetsonnano/" class="">Reducing Jetson Nano OS for Server</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/pi/webserver/" class="">Setting Up Public Webserver on Raspberry Pi</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/worknotes/docs/pi/slurm-cluster/" class="">Setting Up Raspberry Pi Slurm Cluster</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>











  
<ul>
  
  <li>
    <a href="https://github.com/edoyango"  target="_blank" rel="noopener">
        GitHub
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/worknotes/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Faster Vector Sum Reduction</strong>

  <label for="toc-control">
    
    <img src="/worknotes/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#faster-vector-sum-reduce">Faster Vector Sum Reduce</a>
      <ul>
        <li><a href="#single-precision-sse-instructions">Single precision, SSE instructions</a>
          <ul>
            <li><a href="#performance">Performance</a></li>
          </ul>
        </li>
        <li><a href="#single-precision-avx-instructions">Single precision, AVX instructions</a>
          <ul>
            <li><a href="#performance-1">Performance</a></li>
            <li><a href="#performance-with-llvm-compiler-clang">Performance with LLVM compiler (<code>clang++</code>)</a></li>
          </ul>
        </li>
        <li><a href="#double-precision-sse-instructions">Double precision, SSE instructions</a>
          <ul>
            <li><a href="#performance-2">Performance</a></li>
            <li><a href="#performance-with-llvm-compiler-clang-1">Performance with LLVM compiler (<code>clang++</code>)</a></li>
          </ul>
        </li>
        <li><a href="#double-precision-avx-instructions">Double precision, AVX instructions</a>
          <ul>
            <li><a href="#performance-3">Performance</a></li>
          </ul>
        </li>
        <li><a href="#conclusion">Conclusion</a></li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="faster-vector-sum-reduce">
  Faster Vector Sum Reduce
  <a class="anchor" href="#faster-vector-sum-reduce">#</a>
</h1>
<p>In 
  <a href="/worknotes/docs/manual-vectorization/sumreduce/">my page introducing vectorized reductions</a>, I show how to use horizontal adds (<code>hadd</code>) functions to
perform the reduction. However, this 
  <a href="https://stackoverflow.com/questions/6996764/fastest-way-to-do-horizontal-sse-vector-sum-or-other-reduction/35270026">doesn&rsquo;t produce optimal assembly</a>, so isn&rsquo;t the fastest way to do things.</p>
<p>This page will demonstrate a faster version to do each of the examples shown previously.</p>
<h2 id="single-precision-sse-instructions">
  Single precision, SSE instructions
  <a class="anchor" href="#single-precision-sse-instructions">#</a>
</h2>
<p>This section will show a faster sum-reduce example which makes use of 128-bit single precision vectors and SSE
instructions.</p>
<p>After loading the vector <code>va</code>, a new vector is created using <code>_mm_movehdup_ps</code>, using <code>a</code> as an input. This function
duplicates the second and fourth elements, and duplicates them to one element lower.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// __m128 va = _mm_set_ps(a0, a1, a2, a3);
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">__m128</span> <span style="color:#000">shuf</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_movehdup_ps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">va</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// shuf = [a1, a1, a3, a3]
</span></span></span></code></pre></div><p>The resultant vector is then added back to <code>va</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">__m128</span> <span style="color:#000">sums</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_add_ps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">va</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">shuf</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// sums = [a0+a1, a1+a1, a2+a3, a3+a3]
</span></span></span></code></pre></div><p><code>shuf</code> and <code>sums</code> are combined together with <code>_mm_movehl_ps</code>. This function replaces the lower two elements of the first
input vector, with the upper two elements of the second vector.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#000">shuf</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_movehl_ps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">shuf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sums</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// shuf = [sums2, sum3, shuf2, shuf3]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//      = [a2+a3, a3+a3, a3, a3]
</span></span></span></code></pre></div><p>We finally add the lowermost element of <code>shuf</code> and <code>sums</code> to get the reduced sum in the lowermost element of the <code>sums</code>
vector, and the remaing elements can be ignored.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#000">sums</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_add_ss</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sums</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">shuf</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// sums = [sums0+shuf0, sums1, sums2, sums3]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//      = [a0+a1+a2+a3, a1+a1, a2+a3, a3+a3]
</span></span></span></code></pre></div><p>Implemented into our previous example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">reduce_128_sgl_SSE3</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">nelem</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">float</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">float</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">nelem</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">__m128</span> <span style="color:#000">vb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_set_ss</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">__m128</span> <span style="color:#000">va</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_loadu_ps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">__m128</span> <span style="color:#000">shuf</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_movehdup_ps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">va</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">__m128</span> <span style="color:#000">sums</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_add_ps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">va</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">shuf</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">shuf</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_movehl_ps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">shuf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sums</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">sums</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_add_ss</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sums</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">shuf</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">vb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_add_ss</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sums</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">_mm_store_ss</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">vb</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="performance">
  Performance
  <a class="anchor" href="#performance">#</a>
</h3>
<p>Compilation command:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>g++ -o reduce.x reduce.cpp -msse4 -isystem benchmark/include -Lbenchmark/build/src -lbenchmark -lpthread -std<span style="color:#ce5c00;font-weight:bold">=</span>c++17 -O2
</span></span></code></pre></div><p>Comparison with base case:</p>
<pre tabindex="0"><code>Comparing reduce_base_sgl (from reduce_base_sgl.json) to reduce_128_sgl_SSE3 (from reduce_128_sgl_SSE3.json)
Benchmark                                                Time       CPU   Time Old   Time New    CPU Old    CPU New
-------------------------------------------------------------------------------------------------------------------
[reduce_base_sgl vs. reduce_128_sgl_SSE3]/4096        -0.6108   -0.6107       1625        633       1621        631
[reduce_base_sgl vs. reduce_128_sgl_SSE3]/32768       -0.6270   -0.6271      13565       5059      13531       5046
[reduce_base_sgl vs. reduce_128_sgl_SSE3]/262144      -0.5984   -0.5983     108413      43541     108135      43439
[reduce_base_sgl vs. reduce_128_sgl_SSE3]/2097152     -0.5380   -0.5379     872616     403151     870408     402208
[reduce_base_sgl vs. reduce_128_sgl_SSE3]/16777216    -0.2613   -0.2613    8405297    6209082    8385642    6194461
[reduce_base_sgl vs. reduce_128_sgl_SSE3]/134217728   -0.2114   -0.2114   68570641   54072282   68394712   53933850
OVERALL_GEOMEAN                                       -0.4997   -0.4996          0          0          0          0
</code></pre><p>Comparison with horizontal add strategy:</p>
<pre tabindex="0"><code>Comparing reduce_128_sgl (from reduce_128_sgl.json) to reduce_128_sgl_SSE3 (from reduce_128_sgl_SSE3.json)
Benchmark                                               Time       CPU   Time Old   Time New    CPU Old    CPU New
------------------------------------------------------------------------------------------------------------------
[reduce_128_sgl vs. reduce_128_sgl_SSE3]/4096        -0.4926   -0.4925       1247        633       1243        631
[reduce_128_sgl vs. reduce_128_sgl_SSE3]/32768       -0.4930   -0.4930       9978       5059       9953       5046
[reduce_128_sgl vs. reduce_128_sgl_SSE3]/262144      -0.4553   -0.4553      79935      43541      79748      43439
[reduce_128_sgl vs. reduce_128_sgl_SSE3]/2097152     -0.3698   -0.3697     639709     403151     638091     402208
[reduce_128_sgl vs. reduce_128_sgl_SSE3]/16777216    -0.1334   -0.1332    7164522    6209082    7146262    6194461
[reduce_128_sgl vs. reduce_128_sgl_SSE3]/134217728   -0.1041   -0.1042   60358462   54072282   60204987   53933850
OVERALL_GEOMEAN                                      -0.3602   -0.3602          0          0          0          0
</code></pre><p>The new vectorized reduction is between 1.1x to 2x faster than the previous attempt using horizontal adds. This brings
up the speedup compared to the original to ~1.3x to ~2.6x times. Like every other example, performance gains are
greater the closer the data is to the CPU core.</p>
<h2 id="single-precision-avx-instructions">
  Single precision, AVX instructions
  <a class="anchor" href="#single-precision-avx-instructions">#</a>
</h2>
<p>This implementation is not much different from the previous version, in that the reduction using a 256-bit vector is
performed by splitting the 256-bit vector into 2 128-bit vectors, adding them, and performing the same reduction
algorithm for 128-bit vectors:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">reduce_256_sgl_AVX</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">nelem</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">float</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">float</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">nelem</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">__m128</span> <span style="color:#000">vb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_set_ss</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">__m256</span> <span style="color:#000">va</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm256_loadu_ps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">__m128</span> <span style="color:#000">va_lo</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm256_castps256_ps128</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">va</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">__m128</span> <span style="color:#000">va_hi</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm256_extractf128_ps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">va</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">va_lo</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_add_ps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">va_lo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">va_hi</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">__m128</span> <span style="color:#000">shuf</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_movehdup_ps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">va_lo</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">__m128</span> <span style="color:#000">sums</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_add_ps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">va_lo</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">shuf</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">shuf</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_movehl_ps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">shuf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sums</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">sums</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_add_ss</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sums</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">shuf</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">vb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_add_ss</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sums</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">vb</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">_mm_store_ss</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">vb</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="performance-1">
  Performance
  <a class="anchor" href="#performance-1">#</a>
</h3>
<p>First comparing this new version to the first 256-bit vectorized version:</p>
<pre tabindex="0"><code>Comparing reduce_256_sgl (from reduce_256_sgl.json) to reduce_256_sgl_AVX (from reduce_256_sgl_AVX.json)
Benchmark                                              Time       CPU   Time Old   Time New    CPU Old    CPU New
-----------------------------------------------------------------------------------------------------------------
[reduce_256_sgl vs. reduce_256_sgl_AVX]/4096        -0.1999   -0.2001        800        640        798        638
[reduce_256_sgl vs. reduce_256_sgl_AVX]/32768       -0.1937   -0.1935       6419       5175       6401       5162
[reduce_256_sgl vs. reduce_256_sgl_AVX]/262144      -0.1721   -0.1723      52211      43227      52079      43108
[reduce_256_sgl vs. reduce_256_sgl_AVX]/2097152     -0.0966   -0.0966     446301     403176     445074     402074
[reduce_256_sgl vs. reduce_256_sgl_AVX]/16777216    -0.0417   -0.0417    6538546    6266122    6520420    6248835
[reduce_256_sgl vs. reduce_256_sgl_AVX]/134217728   -0.0436   -0.0436   57544865   55037665   57385371   54886129
OVERALL_GEOMEAN                                     -0.1271   -0.1272          0          0          0          0
</code></pre><p>The performance has definitely improved, albeit marginally for the test sizes in RAM. But compared to the 128-bit
version, it actually performs very similarly (perhaps even a bit worse):</p>
<pre tabindex="0"><code>Comparing reduce_128_sgl_SSE3 (from reduce_128_sgl_SSE3.json) to reduce_256_sgl_AVX (from reduce_256_sgl_AVX.json)
Benchmark                                                   Time       CPU   Time Old   Time New    CPU Old    CPU New
----------------------------------------------------------------------------------------------------------------------
[reduce_128_sgl_SSE3 vs. reduce_256_sgl_AVX]/4096        +0.0101   +0.0102        634        640        632        638
[reduce_128_sgl_SSE3 vs. reduce_256_sgl_AVX]/32768       +0.0233   +0.0236       5057       5175       5043       5162
[reduce_128_sgl_SSE3 vs. reduce_256_sgl_AVX]/262144      +0.0210   +0.0208      42337      43227      42231      43108
[reduce_128_sgl_SSE3 vs. reduce_256_sgl_AVX]/2097152     +0.0043   +0.0041     401449     403176     400435     402074
[reduce_128_sgl_SSE3 vs. reduce_256_sgl_AVX]/16777216    +0.0047   +0.0045    6236505    6266122    6220706    6248835
[reduce_128_sgl_SSE3 vs. reduce_256_sgl_AVX]/134217728   -0.0041   -0.0043   55265558   55037665   55122733   54886129
OVERALL_GEOMEAN                                          +0.0099   +0.0098          0          0          0          0
</code></pre><p>I&rsquo;m not 100% sure why this happens. Firstly, there&rsquo;s an additional <code>_mm_add_ps</code> function call, which eats into potential
gains from using 256-bit vectors. And I believe the additional memory operations eat into the remaining gains. The
<code>_mm256_castps256_ps128</code> should be low cost or free as it doesn&rsquo;t move any data around. However, <code>_mm256_extractf128_ps</code>
has to copy the data from the top half of the  original <code>va</code> vector into a different register. Which, I think, is more
costly than an <code>_mm_hadd_ps</code> function call.</p>
<p>Ultimately, from this test, it&rsquo;s probably not worth implementing vector reduction with 256-bit vectors compared to the
fast 128-bit version.</p>
<h3 id="performance-with-llvm-compiler-clang">
  Performance with LLVM compiler (<code>clang++</code>)
  <a class="anchor" href="#performance-with-llvm-compiler-clang">#</a>
</h3>
<p>The LLVM compilers are a different family of compilers form the GNU compilers and can translate the C++ code to assembly
differently. In the case of C++, we use the <code>clang++</code> compiler. Let&rsquo;s compare the performance of our test programs using
<code>clang++</code>.</p>
<p>The compilation command for the manually vectorized code is:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>clang++ -o reduce.x reduce.cpp -mavx2 -Ibenchmark/include -Lbenchmark/build/src -lbenchmark -lpthread -O2
</span></span></code></pre></div><p>The base case needed additional options to ensure no SSE/AVX instructions were introdued:</p>
<pre tabindex="0"><code>-mno-sse -mno-sse2 -mno-sse3 -mno-sse4 -mno-sse4.1 -mno-sse4.2 -mno-avx -mno-avx2
</code></pre><p>First comparing the faster version of the 256-bit vector code with the faster version of the 128-bit vector code.</p>
<pre tabindex="0"><code>Comparing reduce_128_sgl_SSE3 (from reduce_128_sgl_SSE3-clang.json) to reduce_256_sgl_AVX (from reduce_256_sgl_AVX-clang.json)
Benchmark                                                   Time       CPU   Time Old   Time New    CPU Old    CPU New
----------------------------------------------------------------------------------------------------------------------
[reduce_128_sgl_SSE3 vs. reduce_256_sgl_AVX]/4096        -0.4445   -0.4445        572        318        571        317
[reduce_128_sgl_SSE3 vs. reduce_256_sgl_AVX]/32768       -0.4693   -0.4693       4708       2499       4697       2493
[reduce_128_sgl_SSE3 vs. reduce_256_sgl_AVX]/262144      -0.4916   -0.4916      39230      19943      39138      19896
[reduce_128_sgl_SSE3 vs. reduce_256_sgl_AVX]/2097152     -0.5283   -0.5283     338017     159451     337229     159080
[reduce_128_sgl_SSE3 vs. reduce_256_sgl_AVX]/16777216    -0.8006   -0.8006    6395979    1275520    6381010    1272545
[reduce_128_sgl_SSE3 vs. reduce_256_sgl_AVX]/134217728   -0.8162   -0.8162   55513176   10205195   55383675   10181392
OVERALL_GEOMEAN                                          -0.6294   -0.6294          0          0          0          0
</code></pre><p>The AVX code is significantly faster for all the test sizes. For the smallest problem sizes, the AVX code is 1.8x faster
than the new SSE code. Furthermore, the larger the problem gets and further away the data is located from the CPU, the
speedups also increase (up to 5.4x at the largest test size!). Comparing to the base case:</p>
<pre tabindex="0"><code>Comparing reduce_base_sgl (from reduce_base_sgl-clang.json) to reduce_256_sgl_AVX (from reduce_256_sgl_AVX-clang.json)
Benchmark                                               Time       CPU   Time Old   Time New    CPU Old    CPU New
------------------------------------------------------------------------------------------------------------------
[reduce_base_sgl vs. reduce_256_sgl_AVX]/4096        -0.7450   -0.7450       1247        318       1244        317
[reduce_base_sgl vs. reduce_256_sgl_AVX]/32768       -0.7494   -0.7494       9970       2499       9947       2493
[reduce_base_sgl vs. reduce_256_sgl_AVX]/262144      -0.7505   -0.7505      79935      19943      79749      19896
[reduce_base_sgl vs. reduce_256_sgl_AVX]/2097152     -0.7506   -0.7506     639364     159451     637869     159080
[reduce_base_sgl vs. reduce_256_sgl_AVX]/16777216    -0.8318   -0.8318    7581972    1275520    7564185    1272545
[reduce_base_sgl vs. reduce_256_sgl_AVX]/134217728   -0.8375   -0.8375   62785954   10205195   62639140   10181392
OVERALL_GEOMEAN                                      -0.7815   -0.7815          0          0          0          0
</code></pre><p>We now get a speedup of between 3.9x and 6.2x. The lesson here, is that it is important to benchmark your manually
vectorized code with other compilers, as the translation to assembly and the heuristics used to automatically optimise
the code can vary.</p>
<h2 id="double-precision-sse-instructions">
  Double precision, SSE instructions
  <a class="anchor" href="#double-precision-sse-instructions">#</a>
</h2>
<p>This algorithm tricks the compiler to produce optimal code. I don&rsquo;t understand it, but will explain the specific
functions used.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// __m128d va = _mm_set_pd(a0, a1);
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">__m128</span> <span style="color:#000">undef</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_undefined_ps</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// undef = [?, ?, ?, ?]
</span></span></span></code></pre></div><p>This function call simply creates a 128-bit <em>single precision</em> vector with undefined values. Explicitly saying the
vector is undefined apparently helps the compiler optimise the code better.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">__m128</span> <span style="color:#000">shuftmp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_movehl_ps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">undef</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_mm_castpd_ps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">va</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// _mm_castpd_ps(va) = [a0, a0.5, a1, a1.5]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// shuftmp = [a1, a1.5, ?, ?]
</span></span></span></code></pre></div><p>I found this pretty clever when I saw it. The motivation for this trick is that there is no <code>_mm_movehl_ps</code> equivalent
for double precision data. What happens here is:</p>
<ol>
<li><code>va</code> is cast to a single precision vector.
<ul>
<li>This doesn&rsquo;t change the data itself. It only changes how functions interepret it.</li>
<li>i.e., the 128 bits in the vector are still the same.</li>
</ul>
</li>
<li>The upper 64 bits of <code>va</code> (i.e., the second element), is placed in the first element position of <code>undef</code>.</li>
<li>The resultant vector is stored in <code>shuftmp</code>.</li>
</ol>
<p>This effectively moves the 2nd element of <code>va</code> into the first place of <code>undef</code>, despite not having an equivalent
<code>movehl</code> function for double precision. This will be converted back into a double precision vector next.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">__m128d</span> <span style="color:#000">shuf</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_castps_pd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">shuftmp</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// shuf = [a1, ?]
</span></span></span></code></pre></div><p><code>_mm_castps_pd</code> converts <code>shuftmp</code> back into a double precision vector, which is saved as <code>shuf</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#000">va</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_add_sd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">va</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">shuf</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// va = [a0+a1, ?]
</span></span></span></code></pre></div><p>which has the reduced sum in the lower value of <code>va</code>. Implemented into the previous example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">reduce_128_sgl_SSE2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">nelem</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">float</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">float</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">nelem</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">__m128d</span> <span style="color:#000">vb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_set_sd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">__m128</span> <span style="color:#000">va</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_loadu_ps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">__m128</span> <span style="color:#000">undef</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_undefined_ps</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">__m128</span> <span style="color:#000">shuftmp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_movehl_ps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">undef</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_mm_castpd_ps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">va</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">__m128d</span> <span style="color:#000">shuf</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_castps_pd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">shuftmp</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">va</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_add_sd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">va</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">shuf</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">vb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_add_sd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">va</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">_mm_store_sd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">vb</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="performance-2">
  Performance
  <a class="anchor" href="#performance-2">#</a>
</h3>
<p>Compilation command:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>g++ -o reduce.x reduce.cpp -msse4 -isystem benchmark/include -Lbenchmark/build/src -lbenchmark -lpthread -std<span style="color:#ce5c00;font-weight:bold">=</span>c++17 -O2
</span></span></code></pre></div><p>Comparison with base case:</p>
<pre tabindex="0"><code>Comparing reduce_base_dbl (from reduce_base_dbl.json) to reduce_128_dbl_SSE2 (from reduce_128_dbl_SSE2.json)
Benchmark                                                Time       CPU    Time Old    Time New     CPU Old     CPU New
-----------------------------------------------------------------------------------------------------------------------
[reduce_base_dbl vs. reduce_128_dbl_SSE2]/4096        -0.1979   -0.1978        1627        1305        1623        1302
[reduce_base_dbl vs. reduce_128_dbl_SSE2]/32768       -0.1842   -0.1843       13462       10982       13431       10956
[reduce_base_dbl vs. reduce_128_dbl_SSE2]/262144      -0.1666   -0.1667      112035       93353      111772       93135
[reduce_base_dbl vs. reduce_128_dbl_SSE2]/2097152     -0.1767   -0.1765      934021      768984      931648      767179
[reduce_base_dbl vs. reduce_128_dbl_SSE2]/16777216    -0.0174   -0.0172    12864721    12640848    12831738    12611107
[reduce_base_dbl vs. reduce_128_dbl_SSE2]/134217728   -0.0080   -0.0078   107276227   106417505   107002000   106168603
OVERALL_GEOMEAN                                       -0.0729   -0.0724           0           0           0           0
</code></pre><p>The gains are modest, with a speedup of 1.2x at most. Comparison with horizontal add strategy:</p>
<pre tabindex="0"><code>Comparing reduce_128_dbl (from reduce_128_dbl.json) to reduce_128_dbl_SSE2 (from reduce_128_dbl_SSE2.json)
Benchmark                                               Time       CPU    Time Old    Time New     CPU Old     CPU New
----------------------------------------------------------------------------------------------------------------------
[reduce_128_dbl vs. reduce_128_dbl_SSE2]/4096        -0.1037   -0.1033        1456        1305        1452        1302
[reduce_128_dbl vs. reduce_128_dbl_SSE2]/32768       -0.0828   -0.0828       11973       10982       11945       10956
[reduce_128_dbl vs. reduce_128_dbl_SSE2]/262144      -0.1349   -0.1347      107906       93353      107633       93135
[reduce_128_dbl vs. reduce_128_dbl_SSE2]/2097152     -0.1437   -0.1435      898008      768984      895718      767179
[reduce_128_dbl vs. reduce_128_dbl_SSE2]/16777216    -0.0293   -0.0291    13022105    12640848    12988742    12611107
[reduce_128_dbl vs. reduce_128_dbl_SSE2]/134217728   -0.0180   -0.0178   108369477   106417505   108088106   106168603
OVERALL_GEOMEAN                                      -0.0667   -0.0991           0           0           0           0
</code></pre><p>Which shows that this faster version is 1.1-1.4x faster than the horizontal add version.</p>
<h3 id="performance-with-llvm-compiler-clang-1">
  Performance with LLVM compiler (<code>clang++</code>)
  <a class="anchor" href="#performance-with-llvm-compiler-clang-1">#</a>
</h3>
<p>Like with the single precision AVX code, we can see whether using <code>clang++</code> changes performance. The compiler options
remain the same for the manually vectorized code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>clang++ -o reduce.x reduce.cpp -mavx2 -Ibenchmark/include -Lbenchmark/build/src -lbenchmark -lpthread -O2
</span></span></code></pre></div><p>The base case needed additional options to ensure no SSE/AVX instructions were introdued:</p>
<pre tabindex="0"><code>-mno-sse -mno-sse2 -mno-sse3 -mno-sse4 -mno-sse4.1 -mno-sse4.2 -mno-avx -mno-avx2
</code></pre><pre tabindex="0"><code>Comparing reduce_128_dbl (from reduce_128_dbl-clang.json) to reduce_128_dbl_SSE2 (from reduce_128_dbl_SSE2-clang.json)
Benchmark                                               Time       CPU    Time Old    Time New     CPU Old     CPU New
----------------------------------------------------------------------------------------------------------------------
[reduce_128_dbl vs. reduce_128_dbl_SSE2]/4096        -0.4131   -0.4131        1247         732        1244         730
[reduce_128_dbl vs. reduce_128_dbl_SSE2]/32768       -0.0490   -0.0490        9970        9482        9946        9459
[reduce_128_dbl vs. reduce_128_dbl_SSE2]/262144      +0.0132   +0.0132       84054       85161       83857       84962
[reduce_128_dbl vs. reduce_128_dbl_SSE2]/2097152     +0.0415   +0.0416      692974      721728      691305      720034
[reduce_128_dbl vs. reduce_128_dbl_SSE2]/16777216    -0.0231   -0.0230    12876249    12578212    12844822    12548782
[reduce_128_dbl vs. reduce_128_dbl_SSE2]/134217728   -0.0154   -0.0154   108116751   106446645   107853527   106196771
OVERALL_GEOMEAN                                      -0.0904   -0.0903           0           0           0           0
</code></pre><p>And now it looks like the state of things have improved! This new version, compiled with <code>clang++</code>, shows an
improvement, at least for the smallest test size. The others show a minor change, again demonstrating that it&rsquo;s
important to test your code with multiple compilers!</p>
<h2 id="double-precision-avx-instructions">
  Double precision, AVX instructions
  <a class="anchor" href="#double-precision-avx-instructions">#</a>
</h2>
<p>Like the 256-bit vectorized code so far, the pattern is to split the 256-bit vector into two 128-bit vectors, add the
two halves together, and then perform a 128-bit sum reduction. Using the faster version of the single precision 128-bit
reduction, the code looks like:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cpp" data-lang="cpp"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">reduce_256_dbl_AVX</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">nelem</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">double</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">double</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">nelem</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">__m128d</span> <span style="color:#000">vb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_set_sd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">__m256d</span> <span style="color:#000">va</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm256_loadu_pd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">__m128d</span> <span style="color:#000">va_low</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm256_castpd256_pd128</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">va</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">__m128d</span> <span style="color:#000">va_hi</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm256_extractf128_pd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">va</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">va_low</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_add_pd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">va_low</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">va_hi</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">__m128</span> <span style="color:#000">undef</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_undefined_ps</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">__m128</span> <span style="color:#000">shuftmp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_movehl_ps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">undef</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_mm_castpd_ps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">va_low</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">__m128d</span> <span style="color:#000">shuf</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_castps_pd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">shuftmp</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">va_low</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_add_sd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">va_low</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">shuf</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">vb</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">_mm_add_sd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">vb</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">va_low</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">_mm_store_sd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">vb</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="performance-3">
  Performance
  <a class="anchor" href="#performance-3">#</a>
</h3>
<pre tabindex="0"><code>Comparing reduce_256_dbl (from reduce_256_dbl.json) to reduce_256_dbl_AVX (from reduce_256_dbl_AVX.json)
Benchmark                                              Time       CPU    Time Old    Time New     CPU Old     CPU New
---------------------------------------------------------------------------------------------------------------------
[reduce_256_dbl vs. reduce_256_dbl_AVX]/4096        -0.1645   -0.1645         956         799         954         797
[reduce_256_dbl vs. reduce_256_dbl_AVX]/32768       -0.1435   -0.1435        8371        7170        8351        7153
[reduce_256_dbl vs. reduce_256_dbl_AVX]/262144      -0.0466   -0.0466       78961       75280       78776       75103
[reduce_256_dbl vs. reduce_256_dbl_AVX]/2097152     -0.0662   -0.0662      659969      616299      658426      614846
[reduce_256_dbl vs. reduce_256_dbl_AVX]/16777216    -0.0201   -0.0201    12603210    12350490    12573727    12321468
[reduce_256_dbl vs. reduce_256_dbl_AVX]/134217728   -0.0169   -0.0169   106022048   104234811   105773315   103990081
OVERALL_GEOMEAN                                     -0.0781   -0.0781           0           0           0           0
</code></pre><p>The improvement here is meaningful - up to ~16% for smaller problems. When compiled with <code>clang++</code>, the performance
increase is more modest.</p>
<h2 id="conclusion">
  Conclusion
  <a class="anchor" href="#conclusion">#</a>
</h2>
<p>The horizontal add strategy for reducing vectors is acceptable, but by using more subtle choices in vectorization, the
sum reduction can be improved significantly. This was most evident in the 128-bit single precision sum reduction shown
here. The improved algorithm shown on this page, was better than the horizontal add version by up to 2x!</p>
<p>The improved 256-bit version, obtained better performance over the horizontal add version, but only if the <code>clang++</code>
compiler is used. With <code>clang++</code>, the new 256-bit version is approximately between 2x and 5x faster than even the
updated 128-bit sum reduction.</p>
<p>In contrast, the double precision 128-bit and 256-bit improved versions showed here showed modest improvements compared
to the previous vectorized version. Both versions seemed to be a lot faster for the smallest test size when compiled
with <code>clang++</code> (around 2x faster).</p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">


  <div><a class="flex align-center" href="https://github.com/edoyango/personal-webpage/commit/f36f5e3db440090dfd9be7ed4baaf8c081cc42d4" title='Last modified by Edward Yang | August 13, 2023' target="_blank" rel="noopener">
      <img src="/worknotes/svg/calendar.svg" class="book-icon" alt="Calendar" />
      <span>August 13, 2023</span>
    </a>
  </div>



  <div>
    <a class="flex align-center" href="https://github.com/edoyango/personal-webpage/edit/main/worknotes/content/docs/manual-vectorization/faster-sumreduce.md" target="_blank" rel="noopener">
      <img src="/worknotes/svg/edit.svg" class="book-icon" alt="Edit" />
      <span>Edit this page</span>
    </a>
  </div>


</div>



  <script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#faster-vector-sum-reduce">Faster Vector Sum Reduce</a>
      <ul>
        <li><a href="#single-precision-sse-instructions">Single precision, SSE instructions</a>
          <ul>
            <li><a href="#performance">Performance</a></li>
          </ul>
        </li>
        <li><a href="#single-precision-avx-instructions">Single precision, AVX instructions</a>
          <ul>
            <li><a href="#performance-1">Performance</a></li>
            <li><a href="#performance-with-llvm-compiler-clang">Performance with LLVM compiler (<code>clang++</code>)</a></li>
          </ul>
        </li>
        <li><a href="#double-precision-sse-instructions">Double precision, SSE instructions</a>
          <ul>
            <li><a href="#performance-2">Performance</a></li>
            <li><a href="#performance-with-llvm-compiler-clang-1">Performance with LLVM compiler (<code>clang++</code>)</a></li>
          </ul>
        </li>
        <li><a href="#double-precision-avx-instructions">Double precision, AVX instructions</a>
          <ul>
            <li><a href="#performance-3">Performance</a></li>
          </ul>
        </li>
        <li><a href="#conclusion">Conclusion</a></li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












